---
title: "Пример по шагам"
description: "Система amoCRM – удобная web программа для анализа продаж, доступная в режиме online из любой точки мира! Подробности узнавайте по указанным на сайте телефонам в Москве."
url: https://www.amocrm.ru/developers/content/chats/chat-step-by-step
section: developers
---

В данном разделе мы рассмотрим основной функционал любой интеграции в API Чатов, а также разберем остальной функционал,  
который интеграция может реализовать по необходимости.

Мы разберем в этой статье как создать самую простую, но рабочую интеграцию с API Чатов, а также функции,  
которые могут быть полезны для больших, тиражируемых решений.

Любая интеграция, для корректной работы с API чатов, должна реализовать следующий функционал:

- [Подключение канала к аккаунту](#Подключение-канала-к-аккаунту)
- [Отправка сообщения из чата в amoCRM](#Отправка-сообщения-из-чата-в-amoCRM)
- [Получение сообщения, отправленного из amoCRM, разбор вебхука](#Получение-сообщения-отправленного-из-amoCRM-разбор-вебхука)
- [Обновление статуса отправки сообщения](#Обновление-статуса-отправки-сообщения)
- [Отключение канала от аккаунта](#Отключение-канала-от-аккаунта)

Следующие функции будут уже расширением базового функционала интеграции:

- [Разработка тиражируемого решения](#Разработка-тиражируемого-решения)
- [Поддержка и создание множественных источников](#Поддержка-и-создание-множественных-источников)
- [Связывание нового чата с существующим контактом](#Связывание-нового-чата-с-существующим-контактом)
- [Импорт существующей переписки](#Импорт-существующей-переписки)
- [Написать первым](#Написать-первым)
- [Отображение статуса печатания в карточке сделки](#Отображение-статуса-печатания-в-карточке-сделки)
- [Хуки о печати пользователем amoCRM](#Хуки-о-печати-пользователем-amoCRM)
- [Получение истории сообщений чата](#Получение-истории-сообщений-чата)
- [Поддержка реакций](#Поддержка-реакций)

В данной статье будут представлены примеры кода на PHP.  
Все примеры можно скачать [по ссылке](https://www.amocrm.ru/uploads/2021/09/chats_api_example.zip).  
Для уменьшения дублирования кода представим,  
что у нас уже есть файл со вспомогательными методами helpers.php:

```php
 date(DateTimeInterface::RFC2822),
'Content-Type' => $contentType,
'Content-MD5' => strtolower($checkSum),
'X-Signature' => strtolower($signature),
'User-Agent' => 'amoCRM-Chats-Doc-Example/1.0'
];
foreach ($headers as $name => $value) {
$curlHeaders[] = $name . ": " . $value;
}
return $curlHeaders;
}
/\*\*
\* Выполняем запрос к API Чатов
\*
\* @param string $apiMethod Запрашиваемый метод API
\* @param string $requestBody Тело запроса
\* @param array $requestHeaders Заголовки запроса
\* @param string $httpMethod HTTP метод запроса
\*/
function execCurl(
string $apiMethod,
string $requestBody,
array $requestHeaders,
string $httpMethod = 'POST'
): void {
$curl = curl\_init();
$curlOptions = [
CURLOPT\_URL => 'https://amojo.amocrm.ru' . $apiMethod,
CURLOPT\_RETURNTRANSFER => true,
CURLOPT\_TIMEOUT => 5,
CURLOPT\_HTTP\_VERSION => CURL\_HTTP\_VERSION\_1\_1,
CURLOPT\_CUSTOMREQUEST => $httpMethod,
CURLOPT\_HTTPHEADER => $requestHeaders,
];
if (!empty($requestBody)) {
$curlOptions[CURLOPT\_POSTFIELDS] = $requestBody;
}
curl\_setopt\_array($curl, $curlOptions);
$response = curl\_exec($curl);
$error = curl\_error($curl);
$info = curl\_getinfo($curl);
curl\_close($curl);
if ($error) {
echo "cURL Error #:" . $error;
} else {
echo "Status: " . $info['http\_code'] . PHP\_EOL;
echo $response . PHP\_EOL;
}
}
```

### Подключение канала к аккаунту

После создания канала, необходимо выполнить подключение канала к аккаунту.  
Для этого необходимо воспользоваться [методом подключения канала](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Подключение-канала-чата-в-аккаунте).  
Важно отметить, если ваш канал еще не является публичным, то возможность подключения ограниченна перечисленными при регистрации аккаунтами.

После подключения канала к аккаунту, вы получите **scope\_id**, который необходимо использовать для дальнейших запросов.

Рассмотрим пример кода:

```php
 '52e591f7-c98f-4255-8495-827210138c81',
'title' => 'ChatsIntegration',
'hook\_api\_version' => 'v2',
];
$jsonBody = json\_encode($requestBody);
$checkSum = createBodyChecksum($jsonBody);
$apiMethod = sprintf('/v2/origin/custom/%s/connect', $channelId);
// Составим подпись
$signature = createSignature(
$channelSecret,
$checkSum,
$apiMethod
);
// Подготовим заголовки
$curlHeaders = prepareHeaderForCurl($checkSum, $signature);
echo 'POST ' . $apiMethod . PHP\_EOL;
foreach ($curlHeaders as $header) {
echo $header . PHP\_EOL;
}
echo PHP\_EOL . $jsonBody . PHP\_EOL . PHP\_EOL;
// Выполним запрос
execCurl($apiMethod, $jsonBody, $curlHeaders);
```

#### Запрос

```http
POST https://amojo.amocrm.ru/v2/origin/custom/344a5002-f8ca-454d-af3d-396180102ac7/connect
Date: Wed, 15 Dec 2021 23:12:55 +0000
Content-Type: application/json
Content-MD5: 2fbcb3c652b61e24e004daddfc73d0ce
X-Signature: 81211856ce0c5095f3e1a90c0a38dc9d736cfd55
User-Agent: amoCRM-Chats-Doc-Example/1.0
```

#### Тело запроса

```json
{
"account\_id": "52e591f7-c98f-4255-8495-827210138c81",
"title": "ChatsIntegration",
"hook\_api\_version": "v2"
}
```

#### Ответ

```json
{
"account\_id": "52e591f7-c98f-4255-8495-827210138c81",
"scope\_id": "344a5002-f8ca-454d-af3d-396180102ac7\_52e591f7-c98f-4255-8495-827210138c81",
"title": "ChatsIntegration",
"hook\_api\_version": "v2"
}
```

### Отправка сообщения из чата в amoCRM

После подключения канала к аккаунту, вы получите возможность пользоваться методом API.  
Один из первых методов, с которым вы столкнетесь – отправка сообщения из чата в amoCRM.

Для отправки необходимо воспользоваться [методом добавления сообщений](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Отправка-или-импорт-сообщения).

Данный метод позволяет как добавлять входящие сообщение, так и исходящие, в данном разделе рассмотрим кейс входящего сообщения из стороннего чата в amoCRM.

Также стоит отметить, что API чатов не принимает несколько сообщений с одинаковым payload[msgid].  
А также при передаче payload[conversation\_id], которого ранее не было в системе – будет создан новый чат.

Рассмотрим пример кода:

```php
 'new\_message',
'payload' => [
'timestamp' => time(),
'msec\_timestamp' => round(microtime(true) \* 1000),
'msgid' => 'my\_int-5f2836a8ca481',
'conversation\_id' => 'my\_int-d5a421f7f218',
'sender' => [
'id' => 'my\_int-1376265f-86df-4c49-a0c3-a4816df41af8',
'avatar' => 'https://images.pexels.com/photos/10050979/pexels-photo-10050979.jpeg?auto=compress&cs=tinysrgb&dpr=2&w=500',
'profile' => [
'phone' => '+79151112233',
'email' => 'example.client@example.com',
],
'profile\_link' => 'https://example.com/profile/example.client',
'name' => 'Вася клиент',
],
'message' => [
'type' => 'text',
'text' => 'Сообщение от клиента',
],
'silent' => false,
],
];
$jsonBody = json\_encode($requestBody);
$checkSum = createBodyChecksum($jsonBody);
$apiMethod = sprintf('/v2/origin/custom/%s', $scopeId);
// Составим подпись
$signature = createSignature(
$channelSecret,
$checkSum,
$apiMethod
);
// Подготовим заголовки
$curlHeaders = prepareHeaderForCurl($checkSum, $signature);
echo 'POST ' . $apiMethod . PHP\_EOL;
foreach ($curlHeaders as $header) {
echo $header . PHP\_EOL;
}
echo PHP\_EOL . $jsonBody . PHP\_EOL . PHP\_EOL;
// Выполним запрос
execCurl($apiMethod, $jsonBody, $curlHeaders);
```

#### Запрос

```http
POST https://amojo.amocrm.ru/v2/origin/custom/344a5002-f8ca-454d-af3d-396180102ac7\_52e591f7-c98f-4255-8495-827210138c81
Date: Thu, 16 Dec 2021 13:15:29 +0000
Content-Type: application/json
Content-MD5: 223ef85def871bc7cb58aa6f02f0a26e
X-Signature: 29b49e9eaf03f13a66ecaff315f2855b31b25eee
User-Agent: amoCRM-Chats-Doc-Example/1.0
```

#### Тело запроса

Разберем некоторые из параметров запроса, которые могут вызывать вопросы:

- payload[msgid] – в данном поле передаем ID сообщения на стороне вашей интеграции
- payload[conversation\_id] – ID чата на стороне вашей интеграции
- payload[sender][id] – ID отправителя сообщения на стороне вашей интеграции
- payload[sender][avatar] – ссылка на аватар пользователя, спустя небольшое время после передачи сообщения, мы сделаем GET запрос на указанный адрес, чтобы скачать изображение
- payload[sender][profile] – объект с телефоном и email пользователя, поле опционально для передачи в запросе. При создании нового контакта, будут использованы для контроля дублей и зафиксируются в созданной карточке контакта.
- payload[sender][profile\_link] – ссылка на профиль клиента, в данный момент нигде не выводится

Для передачи сообщений с медиа вложениями, необходимо в message[type] указать необходимый тип и передать структуру в соответствии [со спецификацией метода](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Отправка-или-импорт-сообщения).

```json
{
"event\_type": "new\_message",
"payload": {
"timestamp": 1639660529,
"msec\_timestamp": 1639660529379,
"msgid": "my\_int-5f2836a8ca481",
"conversation\_id": "my\_int-d5a421f7f218",
"sender": {
"id": "my\_int-1376265f-86df-4c49-a0c3-a4816df41af8",
"avatar": "https://images.pexels.com/photos/10050979/pexels-photo-10050979.jpeg?auto=compress&cs=tinysrgb&dpr=2&w=500",
"profile": {
"phone": "+79151112233",
"email": "example.client@example.com"
},
"profile\_link": "https://example.com/profile/example.client",
"name": "Вася клиент"
},
"message": {
"type": "text",
"text": "Сообщение от клиента"
},
"silent": false
}
}
```

#### Ответ

В ответе вы получите ID сообщения на стороне amoCRM (new\_message[msgid]).

```json
{
"new\_message": {
"msgid": "8e6afe4e-a08a-4801-b6cb-37963c1a6f3c",
"ref\_id": "my\_int-5f2836a8ca481"
}
}
```

### Получение сообщения, отправленного из amoCRM, разбор вебхука

Когда пользователь отправляет сообщение из amoCRM в ваш канал, мы отправляем на указанный адрес webhook.  
После получения вебхука, вам необходимо обработать его и отправить сообщение в мессенджер.  
Если вы получили сообщение, которое интегрированный мессенджер не может принять, вам необходимо [обновить статус сообщения](#Обновление-статуса-отправки-сообщения) на ошибочный.

Также мы настойчиво рекомендуем обрабатывать сообщения и отправлять в мессенджер вне контекста запроса.  
То есть, при получении вебхука, вы проверяете подпись запроса, а дальше, например, ставите задачу на обработку в очередь и отдаете ответ на вебхук.  
Дальше, уже в асинхронном режиме, вы обрабатываете сообщение, производите вашу бизнес-логику и отправляете сообщение.

В данный момент мы ждем ответа на хук не больше 5 секунд. Для того чтобы мы посчитали хук успешно отправленным,  
ваша интеграция должна ответить на запрос с http-кодом 200.

API Чатов имеет механизмы приоритизации, если интеграция начинает долго отвечать на хуки или не отвечать вовсе,  
мы можем вынести отдельно от основного потока сообщений в медленный поток, в котором хуки могут приходить с задержкой.  
Приоритет рассчитывается динамически и зависят от разных факторов, интеграция может перейти как в более быструю очередь, так и в более медленную.

[Описание формата Webhook’ов от API Чатов (Webhook Reference)](https://www.amocrm.ru/developers/content/chats/chat-webhooks)

Рассмотрим пример кода, который обрабатывает структуру полученного хука:

```php
 '079e44fb-fc22-476b-9e8a-421b688ec53b',
'delivery\_status' => -1,
'error\_code' => 905,
'error' => 'Error text'
];
$jsonBody = json\_encode($requestBody);
$checkSum = createBodyChecksum($jsonBody);
$apiMethod = sprintf('/v2/origin/custom/%s/%s/delivery\_status', $scopeId, $messageId);
// Составим подпись
$signature = createSignature(
$channelSecret,
$checkSum,
$apiMethod
);
// Подготовим заголовки
$curlHeaders = prepareHeaderForCurl($checkSum, $signature);
echo 'POST ' . $apiMethod . PHP\_EOL;
foreach ($curlHeaders as $header) {
echo $header . PHP\_EOL;
}
echo PHP\_EOL . $jsonBody . PHP\_EOL . PHP\_EOL;
// Выполним запрос
execCurl($apiMethod, $jsonBody, $curlHeaders);
```

#### Запрос

```http
POST https://amojo.amocrm.ru/v2/origin/custom/344a5002-f8ca-454d-af3d-396180102ac7\_52e591f7-c98f-4255-8495-827210138c81/079e44fb-fc22-476b-9e8a-421b688ec53b/delivery\_status
Date: Thu, 16 Dec 2021 12:58:40 +0000
Content-Type: application/json
Content-MD5: a0bbbac729c6341f0a521e2db7a8a236
X-Signature: ca51f810785031385a801f41103244713c1a2352
User-Agent: amoCRM-Chats-Doc-Example/1.0
```

#### Тело запроса

```json
{
"msgid": "079e44fb-fc22-476b-9e8a-421b688ec53b",
"delivery\_status": 2,
"error\_code": 905,
"error": "Error text"
}
```

#### Ответ

Метод не возвращает ответа

### Отключение канала от аккаунта

В случае отключения интеграции, необходимо выполнить отключение канала от аккаунта.  
Для этого необходимо воспользоваться [методом отключение канала](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Отключение-канала-чата-в-аккаунте).

Рассмотрим пример кода:

```php
 '52e591f7-c98f-4255-8495-827210138c81',
];
$jsonBody = json\_encode($requestBody);
$checkSum = createBodyChecksum($jsonBody);
$apiMethod = sprintf('/v2/origin/custom/%s/disconnect', $channelId);
// Составим подпись
$signature = createSignature(
$channelSecret,
$checkSum,
$apiMethod,
'DELETE'
);
// Подготовим заголовки
$curlHeaders = prepareHeaderForCurl($checkSum, $signature);
echo 'DELETE ' . $apiMethod . PHP\_EOL;
foreach ($curlHeaders as $header) {
echo $header . PHP\_EOL;
}
echo PHP\_EOL . $jsonBody . PHP\_EOL . PHP\_EOL;
// Выполним запрос
execCurl($apiMethod, $jsonBody, $curlHeaders, 'DELETE');
```

#### Запрос

```http
DELETE https://amojo.amocrm.ru/v2/origin/custom/344a5002-f8ca-454d-af3d-396180102ac7/disconnect
Date: Wed, 15 Dec 2021 23:59:28 +0000
Content-Type: application/json
Content-MD5: 271fa2e4fb0ff84a3ef9689027bd1f38
X-Signature: e1678e3b6aa674b5127f4feb448e6200ce0bfc72
User-Agent: amoCRM-Chats-Doc-Example/1.0
```

#### Тело запроса

```json
{
"account\_id": "52e591f7-c98f-4255-8495-827210138c81"
}
```

#### Ответ

Метод не возвращает тело ответа

### Разработка тиражируемого решения

Вы можете предоставить другим пользователям amoCRM возможность подключить ваш канал к своему аккаунту.  
Для этого необходимо разработать виджет, с помощью которого пользователь сможет связать свой аккаунт с вашим каналом.

Подробнее о разработке виджета вы можете прочитать в [документации по виджетам](https://www.amocrm.ru/developers/content/integrations/intro).

#### Дополнительные требования к виджету для корректной работы с API чатов

В manifest.json, в объект locations вам требуется добавить параметр “lead\_sources”.  
После этого ваш виджет отобразится в разделе подключения источников.

Для отображения в модальном окне подключения интеграций с WhatsApp, необходимо также добавить в объект locations параметр “whatsapp\_modal”.

![Модальное окно подключения источников](https://www.amocrm.ru/uploads/2021/09/sources.png)

После открытия окна подключения источников, пользователь открывает виджет и устанавливает его.  
Затем производит настройку, например вводит логин и пароль,  
JS часть виджета отправляет на ваш сервер связку логин/пароль и ID аккаунта.  
ID аккаунта может быть получен виджетом через следующий JS скрипт: APP.constant("account").amojo\_id  
Ваш сервер проверяет учетные данные и вызывает запрос на подключение нового аккаунта к каналу чатов.  
После установки виджета в Digital Pipeline будет создан источник.

Так как виджет может быть установлен и из маркетплейса, в такое случае мы создадим источник автоматически.

**Если в интеграции устновлена галка "Множественные источники", источник по-умолчанию создан не будет.  
Если интеграция указывает эту галку, мы считаем, что интеграция сама управляет своими источниками.**

#### Пример виджета

[Скачать пример виджета](https://www.amocrm.ru/uploads/2021/09/demo_chat.zip)

### Поддержка и создание множественных источников

По-умолчанию, мы считаем, что канал представляет собой подключение одного типа чата (WhatsApp, Viber, Facebook, Онлайн-чат на cайт и другие)  
и позволяет возможность передавать сообщения между amoCRM и конечной чат-платформой через интеграцию.

Так как бизнес имеет необходимость разделять общение со своими клиентами по нескольким направлениям  
(это может быть несколько телефонных номеров WhatsApp для разных отделов или разные страницы лендингов с онлайн-чатами),  
то и канал общения тоже требуется разделять. Для разделения в рамках одного типа чатов используются *источники*.

Таким образом с помощью источника можно определить, что клиент обратился к бизнесу с определенного лендинга или написал сообщение на телефонный номер конкретного отдела компании.  
И в дальнейшем уже выстроить работу с каждым источником индивидуально: распределение по воронкам и работа ботов в зависимости от источника.

В большинстве случаев, интеграция предоставляет связь между amoCRM и одной конкретной чат-платформой.  
Таким образом интеграции необходим всего лишь один канал для обеспечения передачи сообщений между аккаунтом amoCRM и чат-платформой.

Если источник требуется только 1, то amoCRM создает источник при установке интеграции.  
Если же интеграции требуется несколько источников, это следует учесть при разработке интеграции.

Для реализации поддержки множественных источников интеграции необходимо создать источники через [API](https://www.amocrm.ru/developers/content/crm_platform/sources-api).  
При создании источника, в external\_id необходимо указать идентификатор источника на стороне интеграции.  
Заданный external\_id вы сможете передавать при создании чата или добавлении сообщений, чтобы они были явно связанны с конкретным источником.  
Также external\_id будет приходить в хуках сообщений, которые были написаны в конкретный канал.

Для того чтобы интеграция поддерживала множественные источники, необходимо, чтобы у интеграции был загружен архив, а в locations в manifest.json присутствовало значение "lead\_sources".

Если интеграции не требуется автоматическое создание источника, то в настройках интеграции необходимо установить гавлку "Множественные источники".

#### Источник по-умолчанию

Источник "по-умолчанию" позволяет интеграции указать amoCRM, как работать с чатами, у которых не указан источник или передан незарегистрированный источник.  
Т.е. он позволяет массово разметить уже существующие чаты при внедрении интеграцией множественных источников.

Источников "по-умолчанию" (с полем `default=true`) может быть не более одного на аккаунт для одной интеграции.

Если интеграция не поддерживает работу с множественными источниками, то у нее будет всего 1 источник, который создает amoCRM при добавлении интеграции в качестве источника в Digital Pipeline или установке интеграции.  
У таких источников в поле `external_id` прописан код виджета. Интеграция может его удалить или назначить другой источник "по-молчанию" через API.

В случае, когда интеграция поддерживает работу с множественными источниками, то amoCRM не будет создавать источник "по-умолчанию" самостоятельно при добавлении интеграции администратором в качестве источника.  
И все необходимые источники, интеграция создает уже самостоятельно.  
Для этого надо указать соответствующий флаг в настройках интеграции перед передачей на модерацию виджета интеграции.

Что бы сменить источник по-умолчанию, необходимо через API проставить поле `default=true` у источника. У предыдущего источника (если он был) поле default будет выставлено в `default=false`.

Так как источник "по-умолчанию" не обязателен, то при его удалении ни один другой источник не станет "по-умолчанию" автоматически. Интеграция должна указать новый источник по-умолчанию самостоятельно.

**Важный момент**  
Источник по-умолчанию не привязывается к чатам, если его явно не передавали с сообщениями.

К примеру:  
Есть сделка с контактом и чатом, чат не привязан к источнику.

И существуют 2 источника:

- Отдел технической поддержки
- Отдел продаж

Мы назначаем "Отдел технической поддержки" источником по-умолчанию.  
Теперь при отправке пользователем сообщения в чат интеграции придет источник "Отдел технической поддержки"

Если назначить источником по-умолчанию "Отдел продаж", то в последующих отправленных из amoCRM сообщениях, external\_id в хуке будет равен "Отдел продаж"

Такое поведение будет сохраняться до момента передачи интеграцией источника вместе с сообщением.  
Как только интеграция сообщит, что чат относится к конкретному источнику логика источника по-умолчанию перестанет действовать для чата.  
**Вернуть размеченный чат обратно к логике по-умолчанию уже нельзя.**

#### Особенности работы интеграции с несколькими каналами чатов

*Данные предостережения стоит рассматривать только в случае, если за интеграцией закреплено более 1 канала и интеграция использует возможность "Написать первым"*

Каждая интеграция может управлять только своими источниками, и среди источников интеграции может быть только один источник "по-умолчанию".

Данный момент накладывает дополнительные ограничения на интеграцию при управлении источниками:

- интеграции требуется самостоятельно разрешать конфликты идентификаторов источников на своей стороне
- источник по-умолчанию может использоваться только с одним каналом. Нужно дополнительно прорабатывать процесс миграции на множественные источники
- для каждого чата/сообщения необходимо явно надо передавать источник, что бы все чаты имели явную привязку к источнику
- если будет передан неизвестный для amoCRM источник, то в качестве источника будет указана сама интеграция (тот же источник, что используется при создании сделки через API)

В данной ситуации, одним из решений может быть предоставление выбора источника "по-умолчанию" пользователю в настройках интеграции.  
Что бы пользователь понимал, что для чатов без явного указания источника будет использоваться конкретный канал и выбранный источник.

#### Логика выбора источника при создании чата

Если интеграция не создавала источников самостоятельно,  
то при создании неразобранной сделки из чата, в сделке будет указан созданный нами (при подключении интеграции) источник с названием интеграции.  
Если интеграция передает в сообщениях несуществующий или удаленный источник, тогда мы проверим, есть ли источник по-умолчанию (свойство источника `default=true`).  
Если источника по-умолчанию нет – тогда в сделках будет указан источник с названием интеграции (как при создании неразобранного через API неразобранного).

#### Указание источника при работе с API чатов

Интеграция может указать в [источнике](https://www.amocrm.ru/developers/content/crm_platform/sources-api) воронку, где будет создано неразобранное при первом входящем сообщении.  
Для этого необходимо чтобы внешний идентификатор источника `source[external_id]`,  
передаваемый в [сообщениях](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Отправка-или-импорт-сообщения)  
(или при [создании чата](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Создание-нового-чата)) совпадал с external\_id существующего источника.  
В случае когда пользователь начинает переписку с клиентом первым и при этом пользователь выбрал созданный интеграцией источник, то выбранный источник передается интеграции в [хуке](https://www.amocrm.ru/developers/content/chats/chat-webhooks#Хук-сообщения-v2).  
Таким образом интеграция может понять в рамках какого источника была начата переписка, и, к примеру, для WhatsApp интеграций,  
отправить клиенту сообщения с конкретного подключенного номера телефона, если администратор подключил несколько номеров.

#### Внедрение множественных источников в действующие интеграции

Источник по-умолчанию может быть использован интеграцией при переходе на множественные источники, особенно если  
интеграция поддерживает функционал "Написать первым".

К примеру, имеем исходное состояние:  
Есть аккаунт с подключенной интеграцией с чатами, и эта интеграция поддерживает только 1 источник.  
На данный момент нам не важно как была установлена интеграция: через Digital Pipeline или маркетплейс.

Интеграция начинает внедрение поддержки множественных источников, этот процесс логически разобьем на этапы:

**1 этап**  
Интеграция умеет работать с API источниками (но не отправляет и не принимает источник в сообщениях amoJo).  
На данном этапе интеграция добавляет источник по-умолчанию в аккаунт.  
Данный источник по-умолчанию соответствует источнику, который использовался, когда не было поддержки нескольких источников.  
Теперь в хуках о сообщениях будет приходить `external_id` этого источника для всех чатов, которые явно не закреплены за конкретным источником.

**2 этап**  
Интеграция уже умеет работать с источниками и при отправке сообщений от клиента (при создании чата) указывает external\_id.  
Все чаты с новыми сообщениями становятся размеченными по переданному в сообщении источнику.

Так же интеграция теперь обрабатывает источник и учитывает его при отправке сообщения от менеджера, в том числе при начале чата с клиентом (функционал "Написать первым").

**3 этап**  
Интеграция позволяет администратору аккаунта добавить (через интеграцию) второй и последующие источники.  
Вся переписка по чатам закрепляется за каким-то явно указанным интеграцией источником, все неразмеченные чаты все еще числятся за источником по-умолчанию.

#### Пример цепочки запросов

После установки интеграции и [получения Access Token](https://www.amocrm.ru/developers/content/oauth/step-by-step), интеграция сможет создавать необходимые источники через API.  
Рассмотрим цепочку вызовов:

- Создание источника
- Отправка сообщения с передачей информации об источнике
- Вебхук с информацией об источнике

Представим, что мы разрабатываем интеграцию с WhatsApp с поддержкой нескольких номеров.  
Для начала, создадим пару источников для отдела Продаж (+79039876543) и Технической поддержки (+79001234567).  
Для идентификации источников возьмем номера телефонов которые, поддерживает наша интеграция: 79039876543 и 79001234567 соответственно.  
Телефон технической поддержки будем считать, что пользователь выбрал как источник по умолчанию.  
Также добавим номер отдела продаж – как возможный номер для кнопки на сайт.

Для этого отправим запрос на `POST /api/v4/sources`

##### Запрос

```http
POST /api/v4/sources HTTP/1.1
Host: https://example.amocrm.ru
Content-Type: application/json
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbG....
```

##### Тело запроса

```json
[
{
"name": "Support",
"external\_id": "79001234567",
"services": [],
"default": true
},
{
"name": "Sales",
"external\_id": "79039876543",
"services": [
{
"type": "whatsapp",
"pages": [
{
"id": "79039876543",
"name": "whatsapp",
"link": "+79039876543"
}
]
}
],
"default": false
}
]
```

##### Ответ

```json
{
"\_total\_items": 2,
"\_embedded": {
"sources": [
{
"id": 3108069,
"name": "Support",
"pipeline\_id": 20453,
"external\_id": "79001234567",
"services": [],
"default": true,
"request\_id": "0",
"\_links": {
"self": {
"href": "https://example.amocrm.ru/api/v4/sources/3108069"
}
}
},
{
"id": 3108070,
"name": "Sales",
"pipeline\_id": 20453,
"external\_id": "79039876543",
"services": [
{
"type": "whatsapp",
"pages": [
{
"id": "79039876543",
"name": "whatsapp",
"link": "+79039876543"
}
]
}
],
"default": false,
"request\_id": "1",
"\_links": {
"self": {
"href": "https://example.amocrm.ru/api/v4/sources/3108070"
}
}
}
]
}
}
```

Интеграции необходимо хранить связь external\_id и например, номера телефона, на своей стороне.

Теперь мы можем отправлять сообщение в API Чатов с указанием источника, и неразобранное будет создано в воронке, в которой подключен переданный источник.

В данном случае клиент отправил сообщение на номер Отдела продаж и интеграция указала `external_id` источника в поле `source[external_id]` при отправке сообщения.

##### Запрос

```http
POST https://amojo.amocrm.ru/v2/origin/custom/344a5002-f8ca-454d-af3d-396180102ac7\_52e591f7-c98f-4255-8495-827210138c81
Date: Fri, 17 Dec 2021 10:59:28 +0000
Content-Type: application/json
Content-MD5: 353178c993f09a8ec5f3eab4093b753e
X-Signature: e895539b52051e1a8d3f89d454c7ad7406705234
User-Agent: amoCRM-Chats-Doc-Example/1.0
```

##### Тело запроса

```json
{
"event\_type": "new\_message",
"payload": {
"timestamp": 1639738768,
"msec\_timestamp": 1639738768457,
"msgid": "my\_int-5f2836a8ca481",
"conversation\_id": "my\_int-d5a421f7f218",
"sender": {
"id": "my\_int-1376265f-86df-4c49-a0c3-a4816df41af8",
"avatar": "https://images.pexels.com/photos/10050979/pexels-photo-10050979.jpeg?auto=compress&cs=tinysrgb&dpr=2&w=500",
"profile": {
"phone": "+79151112233",
"email": "example.client@example.com"
},
"profile\_link": "https://example.com/profile/example.client",
"name": "Вася клиент"
},
"message": {
"type": "text",
"text": "Сообщение от клиента"
},
"source": {
"external\_id": "79039876543"
},
"silent": false
}
}
```

##### Ответ

```json
{
"new\_message": {
"msgid": "7779c89e-bb5b-4da0-b802-5de2ab7d4114",
"ref\_id": "my\_int-5f2836a8ca481"
}
}
```

После сообщения менеджера клиенту интеграция получит хук, также с указанием источника в поле `source[external_id]`

По источнику, интеграция должна найти нужный ей мессенджер на своей стороне и отправить ответ клиенту в нужный мессенджер, например, с номера отдела продаж.

#### Тело запроса

```json
{
"account\_id": "52e591f7-c98f-4255-8495-827210138c81",
"time": 1639572261,
"message": {
"receiver": {
"id": "2ed64e26-70a1-4857-8382-bb066a076219",
"phone": "+79151112233",
"email": "example.client@example.com",
"client\_id":"my\_int-1376265f-86df-4c49-a0c3-a4816df41af8"
},
"sender": {
"id": "76fc2bea-902f-425c-9a3d-dcdac4766090"
},
"conversation": {
"id": "8e4d4baa-9e6c-4a88-838a-5f62be227bdc",
"client\_id":"my\_int-d5a421f7f218"
},
"source":{
"external\_id": "79039876543"
},
"timestamp": 1639572260,
"msec\_timestamp": 1639572260980,
"message": {
"id": "0371a0ff-b78a-4c7b-8538-a7d547e10692",
"type": "text",
"text": "Текст сообщения Сделка #15926745",
"tag": "",
"media": "",
"thumbnail": "",
"file\_name": "",
"file\_size": 0
}
}
}
```

### Связывание нового чата с существующим контактом

API Чатов вместе с API amoCRM позволяет создать новый контакт, чат и импортировать туда переписку.  
API Чатов предоставляет отдельный метод создания чата, при вызове которого не будет создан новый контакт или сделка.  
API amoCRM позволяет связать существующий чат с контактом по ID контакта.

С точки зрения бизнес логики, данный пример будет, когда клиент уже существующий и нам не нужно создание неразобранного.  
Контакт в примере создадим для наглядности процесса.

Подробнее о методе создания чата можно прочитать в разделе [API Reference](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Создание-нового-чата).

Для начала создадим новый чат:

```php
 'my\_int-8e3e7640-49af-4448-a2c6-d5a421f7f217',
'source' => [
'external\_id' => '78001234567', // external\_id источника в API Источников, поле не передается, если интеграция не поддерживает множественные источники
],
'user' => [
'id' => 'my\_int-1376265f-86df-4c49-a0c3-a4816df41af9',
'avatar' => 'https://example.com/users/avatar.png',
'name' => 'Имя клиента',
'profile' => [
'phone' => '+79151112233',
'email' => 'example.client@example.com',
],
'profile\_link' => 'https://example.com/profile/example.client',
]
];
$jsonBody = json\_encode($requestBody);
$checkSum = createBodyChecksum($jsonBody);
$apiMethod = sprintf('/v2/origin/custom/%s/chats', $scopeId);
// Составим подпись
$signature = createSignature(
$channelSecret,
$checkSum,
$apiMethod
);
// Подготовим заголовки
$curlHeaders = prepareHeaderForCurl($checkSum, $signature);
echo 'POST ' . $apiMethod . PHP\_EOL;
foreach ($curlHeaders as $header) {
echo $header . PHP\_EOL;
}
echo PHP\_EOL . $jsonBody . PHP\_EOL . PHP\_EOL;
// Выполним запрос
execCurl($apiMethod, $jsonBody, $curlHeaders);
```

#### Запрос

```http
POST https://amojo.amocrm.ru/v2/origin/custom/344a5002-f8ca-454d-af3d-396180102ac7\_52e591f7-c98f-4255-8495-827210138c81/chats
Date: Thu, 16 Dec 2021 23:22:49 +0000
Content-Type: application/json
Content-MD5: 5139e573382c0eae38f476822abb2014
X-Signature: a601e486d694c8e7e8a5b637660f949f8bb7efaf
User-Agent: amoCRM-Chats-Doc-Example/1.0
```

#### Тело запроса

```json
{
"conversation\_id": "my\_int-8e3e7640-49af-4448-a2c6-d5a421f7f217",
"source": {
"external\_id": "78001234567"
},
"user": {
"id": "my\_int-1376265f-86df-4c49-a0c3-a4816df41af9",
"avatar": "https://example.com/users/avatar.png",
"name": "Имя клиента",
"profile": {
"phone": "+79151112233",
"email": "example.client@example.com"
},
"profile\_link": "https://example.com/profile/example.client"
}
}
```

#### Ответ

```json
{
"id": "31d43a78-e09d-46ae-8994-7e93560169b8",
"user": {
"id": "7c7330cd-c0ee-45a5-bd62-643a3a8225e8",
"client\_id": "my\_int-1376265f-86df-4c49-a0c3-a4816df41af9",
"name": "Имя клиента",
"profile": {
"phone": "79151112233",
"email": "example.client@example.com"
},
"avatar": "https://example.com/users/avatar.png"
}
}
```

После создания чата, в качестве примера, создадим контакт. Также вы можете использовать уже существующий контакт.

#### Пример запроса

```http
POST /api/v4/contacts HTTP/1.1
Host: https://{subdomain}.amocrm.ru
Content-Type: application/json
Authorization: Bearer xxxx
```

#### Тело запроса

```json
[
{
"first\_name": "Jack200803",
"last\_name": "Tester"
}
]
```

#### Ответ

```json
{
"\_links": {
"self": {
"href": "https://{subdomain}.amocrm.ru/api/v4/contacts"
}
},
"\_embedded": {
"contacts": [
{
"id": 3102959,
"request\_id": "0",
"\_links": {
"self": {
"href": "https://{subdomain}.amocrm.ru/api/v4/contacts/3102959"
}
}
}
]
}
}
```

После создания контакта, теперь свяжем контакт и созданный чат.

#### Пример запроса

```http
POST /api/v4/contacts/chats HTTP/1.1
Host: https://{subdomain}.amocrm.ru
Content-Type: application/json
Authorization: Bearer xxxx
```

#### Тело запроса

```json
[
{
"contact\_id": 3102959,
"chat\_id": "6cbab3d5-c4c1-46ff-b710-ad59ad10805f"
}
]
```

#### Ответ

```json
{
"\_total\_items": 1,
"\_embedded": {
"chats": [
{
"chat\_id": "6cbab3d5-c4c1-46ff-b710-ad59ad10805f",
"contact\_id": 3102959,
"id": 26219,
"request\_id": "0"
}
]
}
}
```

Также можно проверить привязку чата и контакта. Для этого можно воспользоваться [методом API](https://amocrm.ru/developers/content/api/contacts#contacts-chat-list).

### Импорт существующей переписки

Метод [добавления сообщений](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Отправка-или-импорт-сообщения)  
позволяет, кроме добавления новых сообщение от клиента, производить импорт существующих сообщений.

Импортируемые сообщения могут быть адресованы:

- Входящее от клиента
- Исходящее клиенту от пользователя amoCRM
- Исходящее клиенту от бота интеграции

Метод позволяем импортировать сообщения в чат, не вызывая уведомлений для пользователей amoCRM и создания неразобранного.  
Для этого необходимо передать в метод API поле `payload[silent]: true`.  
При массовом импорте старых сообщений в чат, рекомендуем передавать `payload[silent]: true` со всеми сообщениями, кроме последнего.  
В последнем сообщении (самом свежем) передаем поле `payload[silent]: false`,  
таким образом на последнее сообщение будет создано неразобранное и придет только одно уведомление, тем самым мы не создадим клиенту лишних беспокойств.

Также стоит отметить, что история сообщений в карточке отображается только за 24 часа до даты создания сделки/покупателя.

Подробную спецификацию и примеры можно найти в [API Reference](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Отправка-или-импорт-сообщения).

### Написать первым

Еще одна возможность, которую предоставляет API Чатов – функция Написать первым.  
Для получения доступа к функционалу, при создании чата, в заявке необходимо указать, что вам требуется эта функция.  
Для существующих каналов её также можно включить через поддержку.

После включения функции "Написать первым", пользователи получают возможность создавать новый чат на стороне amoCRM в карточке сделки или через Salesbot.

Уникальным идентификатором для функционала является номер телефона. При создании чата, amoCRM пришлет интеграции вебхук v2.

Отличительной особенностью данного хука является отсутствие поля message[conversation][client\_id],  
в котором в обычных хуках приходит ID чата на стороне интеграции.

Если ваша интеграция поддерживает множественные источники, в хуке вы получите поле message[source][external\_id],  
в котором будет находиться переданный external\_id при создании источника.

Также стоит отметить, что при добавлении нового сообщения через метод [отправки сообщений](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Отправка-или-импорт-сообщения),  
вам необходимо передать payload[conversation\_id] c ID чата на стороне интеграции, а также  
payload[conversation\_ref\_id] с ID чата на стороне API чатов. Передача этих двух параметров позволит связать чат на стороне amoCRM с идентификатором чата на стороне интеграции.  
Для связывания пользователя, которому мы пишем, с ближайшим входящим сообщением необходимо передать  
поле payload[sender][ref\_id] с ID пользователя на стороне API Чатов и payload[sender][id] c ID пользователя на стороне интеграции.

### Отображение статуса печатания в карточке сделки

Некоторые мессенджеры уведомляют интеграции о том, что пользователь сейчас печатает. Интеграция может уведомить об этом amoCRM.  
В таком случае в карточке, в которой отображается чат, появится анимация печати от имени пользователя мессенджера (клиента).

![](https://www.amocrm.ru/uploads/2021/09/typing_vasiliy.png)

Важно отметить, что в запросе передается ID чата на стороне интеграции (ID переданный при отправке сообщения в payload[conversation\_id]).  
Также передается ID пользователя на стороне интеграции, который печатает.

Рассмотрим пример кода:

```php
 'my\_int-d5a421f7f218',
'sender' => [
'id' => 'my\_int-1376265f-86df-4c49-a0c3-a4816df41af8',
],
];
$jsonBody = json\_encode($requestBody);
$checkSum = createBodyChecksum($jsonBody);
$apiMethod = sprintf('/v2/origin/custom/%s/typing', $scopeId);
// Составим подпись
$signature = createSignature(
$channelSecret,
$checkSum,
$apiMethod
);
// Подготовим заголовки
$curlHeaders = prepareHeaderForCurl($checkSum, $signature);
echo 'POST ' . $apiMethod . PHP\_EOL;
foreach ($curlHeaders as $header) {
echo $header . PHP\_EOL;
}
echo PHP\_EOL . $jsonBody . PHP\_EOL . PHP\_EOL;
// Выполним запрос
execCurl($apiMethod, $jsonBody, $curlHeaders);
```

#### Запрос

```http
POST https://amojo.amocrm.ru/v2/origin/custom/344a5002-f8ca-454d-af3d-396180102ac7\_52e591f7-c98f-4255-8495-827210138c81/typing
Date: Thu, 16 Dec 2021 16:01:21 +0000
Content-Type: application/json
Content-MD5: 255a22566d68be207fa36804e78a523a
X-Signature: e8263b1daf2b20396c02db6c8c846f95cc0f9540
User-Agent: amoCRM-Chats-Doc-Example/1.0
```

#### Тело запроса

```json
{
"conversation\_id": "my\_int-d5a421f7f218",
"sender": {
"id": "my\_int-1376265f-86df-4c49-a0c3-a4816df41af8"
}
}
```

### Хуки о печати пользователем amoCRM

Мы предоставляем дополнительную возможность для интеграций – получать вебхуки, когда пользователь amoCRM начинает печатать сообщение.  
Для получения подобных хуков вам необходимо обратиться в техническую поддержку или указать это при регистрации нового канала.

Запрос придет на тот же адрес, который был указан как адрес для получения Webhooks.

Мы считаем, что после каждого нажатия на клавишу, пользователь печатает еще до 5 секунд, поэтому в хуке мы присылаем timestamp-метку, показывающую, когда пользователь перестал печатать.  
Вебхук отправляется не чаще, чем раз в 5 секунд.

После получения подобного хука, вам необходимо передать эту информацию в мессенджер, с которым вы интегрируетесь,  
чтобы в мессенджере отобразилась информация о том, что мы сейчас печатаем.

[Описание формата Webhook’ов о печати (Webhook Reference)](https://www.amocrm.ru/developers/content/chats/chat-webhooks#Хук-о-печати)

### Получение истории сообщений чата

С помощью API чатов вы можете получить историю сообщений конкретного чата.  
Для получения истории вам потребуется scope\_id и ID чата на стороне API Чатов,  
который можно получить в хуке о входящем сообщении или при [создании чата через API](https://www.amocrm.ru/developers/content/chats/chat-api-reference##Создание-нового-чата).

Подробный пример доступен в [cпецификации метода получения истории](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Получение-истории-сообщений-по-чату).

### Поддержка реакций

С помощью API чатов вы можете послать реакцию на сообщения или снять реакцию с сообщения [спецификация метода посылки реакции](https://www.amocrm.ru/developers/content/chats/chat-api-reference#Отправка-или-снятие-реакции).

Если интеграция сообщила список поддерживаемых реакций, то менеджеры так же смогут реагировать  
на сообщения из карточки. При этом в интеграцию будет приходить хук [Описание формата Webhook’ов о реакции (Webhook Reference)](https://www.amocrm.ru/developers/content/chats/chat-webhooks#Хук-о-реакции).