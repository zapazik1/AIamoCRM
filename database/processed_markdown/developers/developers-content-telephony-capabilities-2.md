---
title: "Возможности"
description: "Система amoCRM – удобная web программа для анализа продаж, доступная в режиме online из любой точки мира! Подробности узнавайте по указанным на сайте телефонам в Москве."
url: https://www.amocrm.ru/developers/content/telephony/capabilities-2
section: developers
---

Телефония в amoCRM – это интеграция amoCRM со сторонней компанией, предоставляющей услугу виртуальной телефонии, посредством виджетов.

Суть интеграции amoCRM и виртуальной АТС заключается в том, что по определенным событиям происходит обмен данными. Таких событий несколько, из них формируются возможности, дальше мы рассмотрим каждую возможность в подробности и приведём примеры их реализации.

### Карточка входящего звонка

В системе amoCRM реализована возможность выводить в левом нижнем углу окошко с уведомлением. Как пример использования можно назвать уведомление о входящем звонке вызываемой телефонией.

#### Существует два основных способа создания уведомлений о звонке:

Создание уведомления с помощью публичного метода API [POST /api/v4/events](/developers/content/telephony/call_event). Данный метод автоматически найдет сущность(контакт/компанию/сделку/покупателя) по переданному номеру телефона и отобразит уведомление с этой сущностью для нужного сотрудника. Если же сущности с таким номером еще нет в базе, то уведомление будет содержать в себе ссылку на создание нового контакта с этим номером.

Другой способ – это создание уведомлений с помощью JS части виджета. Непосредственно в момент поступления звонка на телефон сотрудника, виртуальная АТС имеет возможность запросить через API amoCRM информацию о звонящем контакте и передать ее сотруднику. Для осуществления поиска необходимо использовать метод [GET /api/v4/contacts](/developers/content/api/contacts), передавая в параметр query телефонный номер. Как и все методы API, данный метод вызываются из-под авторизованного пользователя, а соответственно учитываются права пользователя на доступ к контактам. Т.е. для определения номера данный контакт должен быть в базе amoCRM и у соответствующего пользователя должны быть права на просмотр нужной карточки контакта.

Обязательно нужно ставить минимальный timeout на отработку запроса, т.к. иначе, в случае деградации связи между АТС и amoCRM, возможны проблемы со звонками.

Для доставки информации о входящем звонке до JS-скрипта на стороне клиента обычно используются технологии web- sockets, когда между клиентом и сервером устанавливается постоянное соединение и подписка на события. Можно использовать технологию периодических обращений через JS на сторонний сервер. Для этого раз в несколько секунд на стороне клиента подгружается JS-файл с целевого сервера, где определяется массив с состоянием канала (есть вызов, нет вызова для конкретного внутреннего телефона сотрудника).

Выбор метода зависит от технической возможности на стороне виртуальной АТС поддерживать web-sockets соединение. При этом необходимо учитывать внутренние номера сотрудников и их соответствие авторизованным в amoCRM пользователям, просматривающим интерфейс.

#### Пример карточки входящего звонка

![](https://i.postimg.cc/d0crWCBR/Screenshot-10-1.png)

Для реализации карточки входящего звонка можно использовать предусмотренный объект. В примере функция, созданная для работы с ним.

#### Пример

```javascript
/\* script.js \*/
self.add\_call\_notify = function (data) {
var w\_name = self.i18n('widget').name,
date\_now = Math.ceil(Date.now() / 1000),
lang = self.i18n('settings'),
n\_data = {
from: data.from,
to: data.to,
duration: data.duration,
link: data.link,
text: w\_name + ': ' + data.text,
date: date\_now,
element: data.element,
click\_link: data.element && data.element.id > 0 ? '' : "/contacts/add/?phone=" + data.from, //ваша ссылка
};
/\* Делаем проверку, существует ли ID контакта, совершающего входящий вызов \*/
if (n\_data.element.id > 0) { //Если ID существует, формируем ссылку на данный контакт в amoCRM
var text = 'Вам звонит:' + n\_data.element.name + 'Перейти в карту контакта';
n\_data.text = text;
n\_data.from = data.from;
if (n\_data.from.length >.

#### Пример

```javascript
self.add\_call\_notify = function(data) {
var w\_name = self.i18n('widget').name,
date\_now =
Math.ceil(Date.now() / 1000),
lang = self.i18n('notifications'),
text,
n\_data = {
to: data.to,
duration: data.duration,
date: date\_now,
element: data.element
};
// Делаем проверку, существует ли ID контакта, совершающего входящий вызов
if (n\_data.element.id > 0) { // Если ID существует, формируем ссылку на данный контакт в amoCRM
text = 'Вам звонит: ' + n\_data.element.name + 'Перейти в карту контакта';
n\_data.text = text;
n\_data.from = data.from;
if (n\_data.from.length Создать контакт';
n\_data.text = text;
n\_data.header = 'Входящий вызов ' + data.from; // Обратите внимание, в случае создания нового контакта, n\_data.from не заполняется!
}
APP.notifications.add\_call(n\_data);
};
/\* Далее данные, имитирующие поступающую информацию \*/
var notify\_data = {};
notify\_data.from = '+7 (998) 444 55 66';
notify\_data.to = 'User Name';
self.add\_call\_notify(notify\_data);
```

### Умная переадресация

При поступлении звонка, кроме информации об имени звонящего, вы также можете получить ID пользователя amoCRM, ответственного за карточку звонящего контакта. Из информации об аккаунте вы можете получить телефонный номер ответственного сотрудника и произвести переадресацию вызова именно работающему с контактом человеку.

Для реализации этой возможности вам понадобится составить несколько запросов к нашему API, чтобы в итоге получить телефонный номер сотрудника ответственного за карточку звонящего контакта.

#### Пример

```php
$phone\_number = /\* Номер телефона входящего вызова \*/ ;
$subdomain = /\* Ваш аккаунт — поддомен \*/;
$link = 'https://'.$subdomain.'.amocrm.ru/api/v4/contacts?query='.$phone\_number; // Запрос к API на поиск карточки контакта
$curl = curl\_init();
# Сохраняем дескриптор сеанса cURL
# Устанавливаем необходимые опции для сеанса cURL
curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true);
curl\_setopt($curl, CURLOPT\_USERAGENT, 'amoCRM-API-client/1.0');
curl\_setopt($curl, CURLOPT\_URL, $link);
curl\_setopt($curl, CURLOPT\_HEADER, false);
curl\_setopt($curl, CURLOPT\_COOKIEFILE, dirname(\_\_FILE\_\_).'/cookie.txt');
curl\_setopt($curl, CURLOPT\_COOKIEJAR, dirname(\_\_FILE\_\_).'/cookie.txt');
curl\_setopt($curl, CURLOPT\_SSL\_VERIFYPEER, 0);
curl\_setopt($curl, CURLOPT\_SSL\_VERIFYHOST, 0);
$out = curl\_exec($curl);
#Инициируем запрос к API и сохраняем ответ в переменную
$code = curl\_getinfo($curl, CURLINFO\_HTTP\_CODE);
curl\_close($curl);
$Response = json\_decode($out, true);
/\* Из ответа, на запрос карточки пользователя, получаем ID ответственного пользователя \*/
$responsible\_user\_id = $Response['response']['contacts'][0]['responsible\_user\_id'];
```

$responsible\_user\_id будет ID пользователя, ответственного за карточку совершающего вызов контакта. Т.к. данные пользователей на аккаунте amoCRM и в базе виджета телефонии совпадают, что является одним из условий подключения виджета телефонии, вы можете перевести входящий вызов на ответственного пользователя.

### Результат звонка

Функция реализуется путём запуска модального окна, в котором можно реализовать создание новой сделки или контакта, с указанием примечания или задачи, которые будут связаны с созданной сущностью.

#### Пример результата звонка

![](https://i.postimg.cc/tRsd49Yx/call-result-example-2.png)

**Модальное окно состоит из следующих элементов:**

1. Название окна
2. Привязанная сущность / возможность привязки сущности(сделка/контакт/покупатель/компания)
3. Панель записанного звонка (с указанием продолжительности звонка и возможностью прослушивания)
4. Панель статуса завершенного звонка
5. Окно добавления примечания

- Если звонок исходящий на неизвестный / входящий с неизвестного номера – в заголовке будет обозначен номер телефона неизвестного абонента, а в графе привязки звонка будет пусто. При редактировании контакта будет также создана сделка. Звонок привязывается по [специальному алгоритму добавления звонков](https://www.amocrm.ru/developers/content/crm_platform/calls-api)
- Если звонок входящий с известного номера, то:
- Отобразится сделка, если у контакта только одна сделка.
- Отобразится покупатель, если к контакту привязана только сущность покупателя.
- Отобразится компания, если номер был занесен отдельно в графе самой компании.
- Отобразится контакт, если у него привязаны и покупатель, и сделка или несколько сделок – то высветится окно контакта.
- При нажатии кнопки > после разговора с неизвестным контактом звонок окажется в неразобранном.

Архив с шаблоном модального окна вы можете скачать [здесь](/static/assets/developers/files/examples/call_result_modal_example.zip)

Необходимо учитывать, что для успешного запуска модального окна, скрипт вашего виджета должен начинаться так, как показано в примере ниже.

#### Пример

```javascript
define(['jquery', 'lib/components/base/modal'], function($, Modal) {
/\* Здесь скрипт вашего виджета \*/
});
```

Для примера реализации данной возможности, создадим модальное окно, с разметкой для ввода информации и опишем запросы к API, для занесения информации в базу данных. Подробнее о структуре запросов на добавление сущностей через запросы к API, читайте здесь.

#### Пример

```javascript
setTimeout(self.call\_result, 30000); // Устанавливаем задержку вызова функции результата звонка
this.call\_result = function () {
// Составляем разметку формы вводы данных, которая будет отображаться в модальном окне
var data = [];
data.push(
'' +
'input[type="text"] {' +
'border: 1px solid #696969;' +
'border-radius: 3px;' +
'-webkit-border-radius: 3px;' +
'-moz-border-radius:3px;' +
'margin: 2px;' +
'padding: 2px' +
'}' +
'input[type= submit] {' +
'background-color: #20B2AA;' +
'border: 1px #008B8B;' +
'border-radius: 3px;' +
'padding: 3px' +
'}' +
'' +
'' +
'Результат звонка + 7(999) 888-77-66' +
'' +
'' +
'' +
'' +
'Тип задачи' +
'' +
'Связаться с клиентом' +
'Встреча' +
'' +
'Срок выполнения задачи' +
'' +
'Сутки' +
'Трое суток' +
'Неделя' +
'' +
'Поставить задачу' +
'' +
'' +
'' +
'',
);
modal = new Modal({
class\_name: 'modal-window',
init: function ($modal\_body) {
$modal\_body
.trigger('modal:loaded') // Запускает отображение модального окна
.html(data)
.trigger('modal:centrify') // Настраивает модальное окно
.append('Отмена');
},
destroy: function () {},
});
$('#call\_result\_data input[type = "submit"]').click(function (e) {
e.preventDefault();
var data; // Переменная, которая будет содержать данные серилизации
data = $(this).parent('form').serializeArray();
setTimeout('$(".modal-body\_\_close").trigger("click")', 1000);
if (data[1]['value'] != '') {
var complex\_data = [],
contact\_data = [],
task\_data = [],
note\_data = [];
if (data[0]['value'] != '') {
contact\_data = [
{
name: data[0]['value'],
},
];
}
complex\_data = JSON.stringify([
{
name: data[1]['value'],
\_embedded: {
contacts: contact\_data,
},
},
]);
$.post(
'/api/v4/leads/complex',
complex\_data,
function (response) {
var lead\_id = response[0].id;
if (lead\_id != 0) {
if (data[3]['value'] != '' && data[4]['value'] != '') {
task\_data = JSON.stringify([
{
task\_type\_id: data[3]['value'],
text: data[5]['value'],
entity\_id: lead\_id,
entity\_type: 'leads',
complete\_till:
Math.ceil(Date.now() / 1000) + data[4]['value'],
},
]);
$.post(
'/api/v4/tasks',
task\_data,
function (response) {},
'json',
);
}
if (data[2]['value'] != '') {
note\_data = JSON.stringify([
{
entity\_id: lead\_id,
note\_type: 'common',
params: {
text: data[2]['value'],
},
},
]);
$.post(
'/api/v4/leads/' + lead\_id + '/notes',
note\_data,
function (response) {},
'json',
);
}
}
},
'json',
);
}
});
};
```

### Логирование звонка

Логирование звонков осуществляется в события соответствующей сущности, в соответствующие типы событий исходящего и входящего звонка. Если АТС поддерживает запись звонков, то пользователю может быть выведена ссылка и плеер для прослушивания записанного разговора. Для корректной работы плеера требуется, чтобы сервер, содержащий звонок, отправлял заголовок Accept-Ranges: bytes. Если этот заголовок не передаётся, перемотка звонка может быть неработоспособной.

- через метод [POST /api/v4/calls](https://www.amocrm.ru/developers/content/crm_platform/calls-api)

Метод осуществляет поиск сущностей по номеру телефона автоматически. И прикрепляет звонок к одной из них по определенному алгоритму, более подробно об алгоритме логирования звонков можно прочитать в описании метода. Если сущность с переданным номером телефона не существует в базе, звонок прикреплен не будет.

#### Результат добавления звонков, отображаемый в карточке контакта

![](https://i.postimg.cc/ydGfzZRx/2023-02-07-01-49-42.png)

Есть несколько вариантов отображения информации о звонке.

**Для входящих** – обязательно должен быть передан телефон, с которого поступил звонок. Передается эта информация в свойстве `phone` и отображается в карточке. Также можно передать информацию кому поступил звонок, эта информация передается в свойстве `call_responsible`. В свойство можно передать ID пользователя amoCRM, тогда будет отображено его имя, а можно передать номер телефона или любую строку, например имя сотрудника колл-центра, который не пользуется CRM.

**Для исходящих** – обязательно должен быть передан телефон, на который поступил звонок. Передается эта информация в свойстве `phone` и отображается в карточке. Также можно передать информацию от кого поступил звонок, эта информация передается в свойстве `call_responsible`. Если звонок был совершен из amoCRM, мы рекомендуем передать в свойство ID пользователя amoCRM, тогда будет отображено его имя. Если звонившей не состоит в системе, можно передать номер телефона или любую строку, например имя сотрудника.

### Сообщение об ошибке

Чтобы оповещать пользователя о проблемах, возникающих в фоновых процессах, необходимо воспользоваться отдельным JS- объектом, который при вызове выведет пользователю уведомление об ошибке, к примеру, о неудавшемся подключении к серверу.

Рекомендуем использовать подобные уведомления, если JS на странице производит какие-то фоновые действия (вызываемые скрыто от пользователя, не по его вызову). В таких случаях вы можете уведомлять пользователя о том, что что-то пошло не так и какие действия ему необходимо предпринять.

#### Пример сообщения об ошибке

![](https://i.postimg.cc/Fs16mtQW/show-error-message.png)

#### Параметры

| Параметр | Тип | Описание |
| --- | --- | --- |
| header | string | Имя виджета будет отображаться в заголовке |
| text | string | Сообщение об ошибке |
| date | timestamp | Дата |

callbacks: объект функций обратного вызова. При добавлении нового сообщения или ошибки AJAX запрос отправляется на сервер, который возвращает номер данного сообщения в случае успешного сохранения данных, в зависимости от успешности запроса срабатывает одна из переданных функций данного объекта.

#### Пример

```javascript
var errors = APP.notifications,
date\_now = Math.ceil(Date.now() / 1000),
header = self.get\_settings().widget\_NAME,
text = 'error';
var n\_data = {
header: header, //имя виджета
text: '' + text + '', // Текст уведомления об ошибке
date: date\_now //дата
},
callbacks = {
done: function () {
console.log(' done ');
}, // Успешно добавлено и сохранено AJAX done
fail: function () {
console.log('fail');
}, // AJAX fail
always: function () {
console.log('always');
} // Вызывается всегда
};
errors.add\_error(n\_data, callbacks);
APP.notifications.show\_message\_error(n\_data, callbacks); // Ручной вызов вашего уведомления об ошибке.
```

### Занесение в «Неразобранное»

В amoCRM существует состояние сделки [«Неразобранное»](https://www.amocrm.ru/developers/content/crm_platform/unsorted-api), в которую попадают все обращения из различных интеграций, в том числе и телефонии.

В «Неразобранное» попадают входящие звонки с неизвестных номеров (в системе нет привязанного контакта), принятые пользователем, которые начинают отображаться в колонке «Неразобранное». Пользователь не может самостоятельно перевести обращение в «Неразобранное».

Неразобранное отображает краткую информацию о звонке: телефон звонившего, время звонка, длительность звонка. Звонок можно прослушать или скачать.

Подробнее о добавлении неразобранного со звонком читайте [тут](https://www.amocrm.ru/developers/content/crm_platform/unsorted-api#unsorted-add-sip).

#### Пример добавления звонков в “Неразобранное”

![](https://i.postimg.cc/DwPpP7Qz/unsorted-calls.png)

### Список обзвона

Существует возможность создавать списки обзвона, из списков контаков, компаний и сделок. Для этого необходимо указать желаемые для добавления элементы списка и через вкладку > передать выбранные элементы в ваш список обзвона.

Возможно реализовать автоматический обзвон, с указанным в настройках виджета интервалом времени. Авто-обзвон по созданному списку можно ставить на паузу или пропускать один из элементов списка и переходить к следующему.

В примере мы укажем некоторые ключевые особенности формирования списка обзвона. Полный и исчерпывающий пример реализации вы можете посмотреть самостоятельно в примере полноценного виджета телефонии, в разделе интеграции виджета телефонии, [здесь](/developers/content/telephony/integration).

#### Пример выбора элементов

![](https://i.postimg.cc/LsyyGvbK/select-call-list.png)

#### Пример списка обзвона

![](https://i.postimg.cc/Px9S5JHS/auto-call-list.png)

Для того, чтобы сформировать список обзвона, сперва необходимо реализовать функцию выбора элементов из списка сущностей. Пример реализации выбора элементов для script.js структуры вашего виджета.

#### Пример

```javascript
this.callbacks = {
contacts: {
// Выбираем элементы сущностей из списков контактов или компаний
selected: function () {
var data = self.list\_selected()['selected'],
nothing\_added = true;
$.each(data, function (k, v) {
(function (v) {
var call\_element = {},
list\_model = APP.data.current\_list.where({
id: v.id,
}),
company;
list\_model = list\_model[0] || {};
/\* Получаем данные от каждого выбранного элемента \*/
call\_element.element\_id = v.id;
call\_element.element\_type = list\_model.get('element\_type');
call\_element.type = list\_model.get('element\_type');
call\_element.phone = v.phones[0] || false;
/\* Область видимости списка компаний,
такая же как и область видимости
контактов — clist. В связи с этим,
нам необходимо дополнительно уточнить,
к какой сущности относятся выбранные элементы \*/
call\_element.entity =
call\_element.element\_type == 1 ? 'contact' : 'company';
call\_element.element = {};
call\_element.element.text = list\_model.get('name')['text'];
call\_element.element.url = list\_model.get('name')['url'];
company = list\_model.get('company\_name') || false;
if (company) {
call\_element.company = {};
call\_element.company.text = company.name;
call\_element.company.url = company.url;
}
if (call\_element.phone) {
self.\_\_CallsList.addCall(call\_element); // Передаём выбранные элементы в вашу функцию обработки, addCall не является готовым методом SDK, приведён как пример
nothing\_added = false;
$(document).trigger('list:cookies:update');
} else if (nothing\_added && k == data.length - 1) {
self.notifers.show\_message\_error({
text: self.i18n('caller').nothing\_to\_add,
without\_header: true,
});
}
})(v);
});
},
},
leads: {
// Выбираем элементы из списка сделок selected:
function() {
var data = self.list\_selected()['selected'];
(function (data) {
self.tools.request(
{
selected: data,
},
'get\_contacts\_by\_leads',
function (data) {
data.contacts = data.contacts || [];
if (data.contacts.length  0) {
\_this.calls.push(calls); // Добавление в ваш массив для обзвона, calls не является готовым методом SDK, приведён как пример
}
},
);
return this;
}
```

Пример \*.twig шаблона для списка обзвона.

```twig

 
  { { lang.clear } } 
 { { lang.call\_list } } :
  { { lang.open\_contact\_w\_calling } } 
 

 { { lang.empty\_calls\_list } }

 

     

```

### Функция встроенного звонка (WebRTC)

WebRTC – технология, позволяющая совершать и принимать вызовы прямо в браузере. Стоит принять во внимание, что не все бразуеры или их версии поддерживают данную технологию. Подробнее узнать о поддерживаемых на данный момент браузерах можно на официальной странице технологии.

WebRTC – решение с открытым кодом, и некоторые виджеты для интеграции amoCRM с виртуальными АТС используют его.

Отображение, работающей функции совершения звонков, в различных браузерах выглядит по-разному. В Mozilla Firefox это иконка микрофона. В браузере Google Chrome активная функция отображается в виде красного знака на вкладке и иконки видеокамеры в правой части адресной строки, подтверждающей доступ к вашему микрофону.

#### Пример встроенного звонка

![](https://i.postimg.cc/jdV8VDZ5/webrtc-ex.png)

Пример работы с WebRTC в amoCRM.

#### Пример

```javascript
initYourWidget: function () {
$.getScript('///\* ссылка \*//your\_script.min.js', \_.bind(function () { /\* Обработка вашего скрипта работы с телефонией \*/
}, this));
initialize: function (params) {
APP.widgets.notificationsPhone({
ns:
this.widget.ns, click: \_.bind(function () {
this.$el.toggle(); // Отображение панели работы с WebRTC
}, this)
});
}
}
```