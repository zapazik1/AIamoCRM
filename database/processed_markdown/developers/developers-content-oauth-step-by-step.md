---
title: "Пример по шагам"
description: "Система amoCRM – удобная web программа для анализа продаж, доступная в режиме online из любой точки мира! Подробности узнавайте по указанным на сайте телефонам в Москве."
url: https://www.amocrm.ru/developers/content/oauth/step-by-step
section: developers
---

Для примера рассмотрим полный цикл получения доступа к данным, начиная от регистрации новой интеграции. При этом мы будем рассматривать прямую работу с API авторизации, но вы можете либо воспользоваться нашей готовой [библиотекой на PHP](https://www.amocrm.ru/developers/content/oauth/lib) для упрощения разработки, либо готовыми библиотеками сторонних вендоров, которые можно найти по [ссылке](https://oauth.net/code/).

Мы разрабатывали авторизацию, основываясь на протоколе oAuth 2.0, поэтому вы можете найти в открытых источниках много примеров и документацию, описывающих взаимодействие и логику выполнения запросов.

### Оглавление

- [Регистрация приложения](#Регистрация-приложения)
- [Получение Authorization code](#Получение-Authorization-code)
- [Обмен кода авторизации на access token и refresh token](#Обмен-кода-авторизации-на-access-token-и-refresh-token)
- [Получение нового access token по его истечении](#Получение-нового-access-token-по-его-истечении)
- [Долгосрочные токены](#Долгосрочные-токены)
- [Запросы к API с передачей access token](#Запросы-к-API-с-передачей-access-token)
- [Хук об отключении интеграции](#Хук-об-отключении-интеграции)
- [Обработка ошибок](#Обработка-ошибок)

### Регистрация приложения

Все начинается с того, что вам необходимо зайти в раздел “амоМаркет” того аккаунта, в котором вы будете осуществлять поддержку интеграции в будущем. Обратите внимание:

- Именно за этим аккаунтом будет закреплена Интеграция. Это означает, что любой из администраторов этого аккаунта сможет управлять интеграцией и получит доступ к общим ключам приложения. Подробнее о терминах можно прочесть [здесь](https://www.amocrm.ru/developers/content/oauth/oauth). По сути этот аккаунт мы будем считать аккаунтом разработчика. Если вы разрабатываете публичную интеграции, необходимо ознакомиться с [требованиями](https://www.amocrm.ru/developers/content/integrations/requirements).
- Для создания интеграции вам необходимо обладать правами администратора аккаунта
- При подключении приватной интеграции на аккаунте который не является техническим, клиенту необходимо заполнить заявление на отказ от технической поддержки amoCRM. Техническая поддержка не сможет принять обращения по ошибкам системы для фиксации и исправлений на аккаунте где было подписано заявление. Данное ограничение не касается консультаций и вопросов по оплате. Приняв единожды данное соглашение, оно фиксируется в аккаунте amoCRM навсегда. Отозвать соглашение и вернуть аккаунт к прежнему состоянию возможности уже не будет.

![Приватная интеграция](https://www.amocrm.ru/uploads/2021/12/private_integration.png)

После нажатия на кнопку **Создать Интеграцию**, в появившейся форме, вам необходимо указать Название интеграции, выбрать требуемые доступы и указать описание. Также необходимо указать Redirect URI – url страницы получения токенов и загрузить логотип интеграции. Кроме того, есть возможность указать url для хука об отключении интеграции – на него придет хук, когда интеграция будет отключена пользователем. Поле для хука об отключении является необязательным.

Свойства интеграции:

- Название интеграции (не более 255 символов) – отображается на странице интеграций, модальном окне для предоставления доступов, а также участвует в поиске по странице интеграций.
- Описание интеграции (не более 65000 символов) – отображается в модальном окне интеграции в аккаунте пользователя. Допускается использование html верстки.
- Ссылка для перенаправления – ссылка на ваш сайт, который будет обрабатывать работу с ключами. Важно, что домен должен быть защищен SSL сертификатом, если вы планируете использовать интеграцию более, чем в одном аккаунте.Просим обратить внимание на то, что мы не поддерживаем кириллические домены и кириллические домены, преобразованные с помощью паникода. Также мы периодически проверяем доступность домена, как обязательное условие для работы интеграции.
- Ссылка для хука об отключении интеграции – на этот адрес будет отправлен GET-запрос при отключении интеграции пользователем. В запросе будет содержаться 2 параметра account\_id и client\_id.
- Предоставить доступ – минимальный набор необходимых разрешений для работы интеграции. Подробнее про разрешения можно прочитать в [статье](https://www.amocrm.ru/developers/content/oauth/scopes).
- Иконка интеграции (400х272 jpeg/jpg/png/gif) – отображается в списке интеграций, а также в окне запроса доступа у пользователя
- Контроль дублей – галку необходимо ставить, если ваша интеграция поддерживает [Контроль дублей](https://www.amocrm.ru/developers/content/crm_platform/duplication-control). После установки галки, интеграция будет доступна в настройках контроля дублей.
- Множественные источники – галку необходимо ставить, если ваша интеграция сама управляет источниками через [API](https://www.amocrm.ru/developers/content/crm_platform/sources-api). Если галка установлена, amoCRM не будет создавать источники по-умолчанию, интеграция сама должна будет создать все необходимые ей источники.

Кроме этих пунктов, администраторам аккаунта, в котором создана интеграция, будут доступны: ID интеграции, секретный ключ интеграции, код авторизации (после включения интеграции).

После заполнения полей вам необходимо сохранить интеграцию. После этого новая интеграция будет создана и открыто модальное окно созданной интеграции. В открывшемся модальном окне, на вкладке **ключи** будут отображены необходимые ключи.

Обратите внимание, что Secret key и Integration ID привязаны к интеграции и будут показаны только в вашем аккаунте разработчика.

### Получение Authorization code

Напомним, что код авторизации является временным ключом, который действует только 20 минут. C его помощью вам необходимо в течении этого времени получить refresh token и access токен. Он является временным, т.к. может быть перехвачен, но в случае перехвата злоумышленник не сможет с ним ничего сделать, если вы не сообщите ему ключи приложения, известные только администраторам аккаунта, в котором создана интеграция.

Получить Authorization code можно тремя способами:

- Скопировать из модального окна установленной интеграции. Этот случай подойдет, если вам необходимо проинтегрировать только один аккаунт amoCRM. Подробнее можно прочитать в разделе [Упрощенная авторизация](https://www.amocrm.ru/developers/content/oauth/easy-auth).
- Если в вашей интеграции есть загруженный архив с виджетом, то при его установке вы получите Webhook на указанный в настройках интеграции Redirect URI.
- Получить код через адрес предоставления доступа интеграции. После предоставления доступа, пользовать будет перенаправлен на указанный Redirect URI.

Вы можете упростить разработку при использовании способа получения ключа через GET-параметры, используя готовую [Кнопку amoCRM](https://www.amocrm.ru/developers/content/oauth/button).

Полная логика способа получения ключа через GET-параметры заключается в следующем:

- Пользователь, у которого вы хотите запросить доступ, находится у вас на сайте и может открыть предложенную вами ссылку. \*Внимание: Очень важно, чтобы для пользователя весь процесс был максимально прозрачен и понятен. При клике на ссылку пользователь должен однозначно понимать следующее: произойдет запрос его доступов в его аккаунте amoCRM, какую интеграцию он включает.  
  Именно поэтому мы предлагаем использовать нашу брендированную кнопку, описание которой вы можете найти на странице [Кнопка amoCRM](https://www.amocrm.ru/developers/content/oauth/button)
- Генерация ссылки, по которой должен перейти пользователь. Вам необходимо отправить пользователя на URL  ID}&state={параметр состояния, который будет возвращен вам на Redirect URI}&mode={popup или post\_message}. Integration ID вам уже известен. state – это сгенерированный вами строковый параметр, возможно хеш. State нужен для того, чтобы при получении ответа от amoCRM, вы могли проверить его достоверность, сравнив отправленный ключ и полученный в результате, чтобы удостовериться в отсутствии подмены CSRF. Параметр mode отвечает за обработку запроса на Redirect URI. В случае popup – окно авторизации будет закрыто, а переход на Redirect URI будет выполнен в основном окне. В случае передачи значения post\_message – перенаправление произойдет в окне, которое было открыто, после обработки кода авторизации вам нужно закрыть окно. Также можно сообщить информацию об успешности действия в основное окно с использованием функции [postMessage](https://developer.mozilla.org/ru/docs/Web/API/Window/postMessage).
- Перейдя по ссылке, пользователь увидит логотип вашей интеграции, который вы загружали при ее создании, название, а также перечень доступов, которые запрашивает приложение.  
  Открывать данную страницу мы советуем как модальное окно – в popup. Это позволит пользователю не терять контекста страницы, которая открыла popup. ![Окно предоставления доступов](https://www.amocrm.ru/static/assets/developers/files/oauth/integration_window.png?1)
- В случае, если пользователь не авторизован – ему будет предложено авторизоваться в amoCRM, иначе пользователю будет дан выбор из аккаунтов, где он является администратором. Для приватных интеграций, список будет ограничен 1 аккаунтом.
- После выбора аккаунта и нажатия кнопки Разрешить, интеграция будет установлена в выбранный аккаунт, а пользователь перенаправлен в модальном или основном окне, в зависимости от параметра mode, на указанный в настройках интеграции Redirect URI c GET-параметрами code, referer, state, from\_widget, platform. Параметр code содержит Authorization code, параметр referer – адрес аккаунта пользователя, параметр state – строку, которую вы передавали при открытии окна, если строка не была передана, данный параметр возвращен не будет. Параметр platform показывает, на какой платформе был установлен виджет, российской или глобальной. При установке из аккаунта на amocrm.ru приходит значение 1, при установке из аккаунта на amocrm.com/kommo.com – значение 2. Если мы отправляем Webhook после установки виджета, то вам дополнительно придет GET-параметр from\_widget
- В случае, если пользователь нажмет кнопку Отказать приложению в доступе, он будет перенаправлен на Redirect URI с GET-параметром error=access\_denied, а также GET-параметром state, если он был передан.

#### Пример обработки авторизации, если был передан параметр post\_message

При переданном GET-параметре mode со значением post\_message в окно предоставление доступов – перенаправление произойдет в самом окне. Ниже рассмотрим пример общения окна предоставления доступов и основного окна с использованием функции [postMessage](https://developer.mozilla.org/ru/docs/Web/API/Window/postMessage).  
Код ниже размещен в основном окне:

```js
var popup;
auth();
// 1. Открывает окно предоставления доступов
function auth() {
popup = window.open('https://www.amocrm.ru/oauth?client\_id=XXX&state=XXX&mode=post\_message', 'Предоставить доступ', 'scrollbars, status, resizable, width=750, height=580');
}
// 2. Регистрируем обработчика сообщений из popup окна
window.addEventListener('message', updateAuthInfo);
// 3. Функция обработчик, зарегистрированная выше
function updateAuthInfo(e) {
if (e.data.error !== undefined) {
console.log('Ошибка - ' + e.data.error)
} else {
console.log('Авторизация прошла')
}
// 4. Закрываем модальное окно
popup.close();
}
```

Код ниже будет отдан в модальное окно вашим backend сервером при переходе на Redirect URI:

```html

oAuth Postback

//Передадим данные в родительское окно, набор данных определяете вы
if(window.opener){
window.opener.postMessage({'error': undefined, 'status': 'ok'}, "\*");
}

```

После отработки кода выше, основное окно узнает результат. Рекомендуем закрывать модальное окно автоматически, как это сделано в примере, чтобы у пользователя не возникла путаница в окнах.

### Обмен кода авторизации на access token и refresh token

Получив Authorization code, вам необходимо сделать запрос на специальный метод /oauth2/access\_token, описанный ниже. В ответ вы получите пару Access и Refresh token, а также время в секундах, через которое токен истекает.

Access токен аналогичен ключу сессии. Его можно сохранить в приложении и использовать для запросов к API до истечения времени его жизни. Токен должен быть доступен только вашему приложению, поэтому не рекомендуется сохранять его в cookies браузера, открытых конфигурационных файлах и т. п.

#### Метод

*POST /oauth2/access\_token*

#### Параметры запроса

| Параметр | Тип данных | Описание |
| --- | --- | --- |
| client\_id | string | ID интеграции |
| client\_secret | string | Секрет интеграции |
| grant\_type | string | Тип авторизационных данных (для кода авторизации – authorization\_code) |
| code | string | Полученный код авторизации |
| redirect\_uri | string | Redirect URI указанный в настройках интеграции. Должен четко совпадать с тем, что указан в настройках |

#### Пример запроса

```json
{
"client\_id": "xxxx",
"client\_secret": "xxxx",
"grant\_type": "authorization\_code",
"code": "xxxxxxx",
"redirect\_uri": "https://test.test"
}
```

#### Заголовок типа данных при успешном результате

*Content-Type: application/json*

#### Заголовок типа данных при ошибке

*Content-Type: application/json*

#### HTTP коды ответа

| Код ответа | Условие |
| --- | --- |
| 200 | Запрос успешно обработан |
| 400 | Переданы некорректные данные. Подробности доступны в теле ответа |

#### Параметры ответа

| Параметр | Тип данных | Описание |
| --- | --- | --- |
| token\_type | string | Тип токена |
| expires\_in | int | Через сколько истекает токен |
| access\_token | string | Access Token в формате JWT |
| refresh\_token | string | Refresh Token |

#### Пример ответа

```json
{
"token\_type": "Bearer",
"expires\_in": 86400,
"access\_token": "xxxxxx",
"refresh\_token": "xxxxx"
}
```

#### Получение Access токен по коду авторизации, реализация на bash

```shell
curl https://subdomain.amocrm.ru/oauth2/access\_token -d \
'{"client\_id":"xxx-xxx-xxx-xxx-xxx","client\_secret":"xxxxxx","grant\_type":"authorization\_code","code":"xxxxxxxx","redirect\_uri":"https://test.test/"}' \
-H 'Content-Type:application/json' \
-X POST
```

#### Получение Access токен по коду авторизации, реализация на PHP

```php
 'xxxx',
'client\_secret' => 'xxxx',
'grant\_type' => 'authorization\_code',
'code' => 'xxxxxx',
'redirect\_uri' => 'https://test.ru/',
];
/\*\*
\* Нам необходимо инициировать запрос к серверу.
\* Воспользуемся библиотекой cURL (поставляется в составе PHP).
\* Вы также можете использовать и кроссплатформенную программу cURL, если вы не программируете на PHP.
\*/
$curl = curl\_init(); //Сохраняем дескриптор сеанса cURL
/\*\* Устанавливаем необходимые опции для сеанса cURL \*/
curl\_setopt($curl,CURLOPT\_RETURNTRANSFER, true);
curl\_setopt($curl,CURLOPT\_USERAGENT,'amoCRM-oAuth-client/1.0');
curl\_setopt($curl,CURLOPT\_URL, $link);
curl\_setopt($curl,CURLOPT\_HTTPHEADER,['Content-Type:application/json']);
curl\_setopt($curl,CURLOPT\_HEADER, false);
curl\_setopt($curl,CURLOPT\_CUSTOMREQUEST, 'POST');
curl\_setopt($curl,CURLOPT\_POSTFIELDS, json\_encode($data));
curl\_setopt($curl,CURLOPT\_SSL\_VERIFYPEER, 1);
curl\_setopt($curl,CURLOPT\_SSL\_VERIFYHOST, 2);
$out = curl\_exec($curl); //Инициируем запрос к API и сохраняем ответ в переменную
$code = curl\_getinfo($curl, CURLINFO\_HTTP\_CODE);
curl\_close($curl);
/\*\* Теперь мы можем обработать ответ, полученный от сервера. Это пример. Вы можете обработать данные своим способом. \*/
$code = (int)$code;
$errors = [
400 => 'Bad request',
401 => 'Unauthorized',
403 => 'Forbidden',
404 => 'Not found',
500 => 'Internal server error',
502 => 'Bad gateway',
503 => 'Service unavailable',
];
try
{
/\*\* Если код ответа не успешный - возвращаем сообщение об ошибке \*/
if ($code  204) {
throw new Exception(isset($errors[$code]) ? $errors[$code] : 'Undefined error', $code);
}
}
catch(\Exception $e)
{
die('Ошибка: ' . $e->getMessage() . PHP\_EOL . 'Код ошибки: ' . $e->getCode());
}
/\*\*
\* Данные получаем в формате JSON, поэтому, для получения читаемых данных,
\* нам придётся перевести ответ в формат, понятный PHP
\*/
$response = json\_decode($out, true);
$access\_token = $response['access\_token']; //Access токен
$refresh\_token = $response['refresh\_token']; //Refresh токен
$token\_type = $response['token\_type']; //Тип токена
$expires\_in = $response['expires\_in']; //Через сколько действие токена истекает
```

### Получение нового access token по его истечении

Из предыдущего пункта вы заметили, что вместе с Access token был также возвращен Refresh token. Он необходим для продолжения работы с API, по истечении срока действия Access токена, т.е. это довольно частая операция.

Refresh token имеет два существенных ограничения его жизни:

- Refresh токен действует всего 3 месяца. Если интеграция не используется в течение 3 месяцев, не было ни одного запроса на актуализацию ключа, то интеграция потеряет доступ к данным и будем необходимо повторно запрашивать разрешение у пользователя на доступ к его аккаунту
- Refresh token можно обменять только один раз. После отправки его в метод и получения новой пары access token/refresh token старый refresh token становится не актуальным. И после получения нового refresh token его необходимо обязательно сохранить, иначе придется вновь перезапрашивать доступ у пользователя.

По истечении срока действия возможность получения Access токена по нему становится невозможной. Для обмена необходимо сделать запрос на специальный метод с действительным Refresh токеном. В ответ вы получите новый Access и Refresh токены.

#### Метод

*POST /oauth2/access\_token*

#### Параметры запроса

| Параметр | Тип данных | Описание |
| --- | --- | --- |
| client\_id | string | ID интеграции |
| client\_secret | string | Секрет интеграции |
| grant\_type | string | Тип авторизационных данных (для кода авторизации – refresh\_token) |
| refresh\_token | string | Refresh токен |
| redirect\_uri | string | Redirect URI указанный в настройках интеграции. Должен четко совпадать с тем, что указан в настройках |

#### Пример запроса

```json
{
"client\_id": "xxxx",
"client\_secret": "xxxx",
"grant\_type": "refresh\_token",
"refresh\_token": "xxxxx",
"redirect\_uri": "https://test.test"
}
```

#### Заголовок типа данных при успешном результате

*Content-Type: application/json*

#### Заголовок типа данных при ошибке

*Content-Type: application/json*

#### HTTP коды ответа

| Код ответа | Условие |
| --- | --- |
| 200 | Запрос успешно обработан |
| 400 | Переданы некорректные данные. Подробности доступны в теле ответа |

#### Параметры ответа

| Параметр | Тип данных | Описание |
| --- | --- | --- |
| token\_type | string | Тип токена |
| expires\_in | int | Через сколько истекает токен |
| access\_token | string | Access Token в формате JWT |
| refresh\_token | string | Refresh Token |

#### Пример ответа

```json
{
"token\_type": "Bearer",
"expires\_in": 86400,
"access\_token": "xxxxxx",
"refresh\_token": "xxxxx"
}
```

#### Получение Access токен по Refresh токену, реализация на bash

```shell
curl https://subdomain.amocrm.ru/oauth2/access\_token -d \
'{"client\_id":"xxx-xxx-xxx-xxx-xxx","client\_secret":"xxxxxx","grant\_type":"refresh\_token","refresh\_token":"xxxxxxxx","redirect\_uri":"https://test.test/"}' \
-H 'Content-Type:application/json' \
-X POST
```

#### Получение Access токен по коду авторизации, реализация на PHP

```php
 'xxxx',
'client\_secret' => 'xxxx',
'grant\_type' => 'refresh\_token',
'refresh\_token' => 'xxxxxx',
'redirect\_uri' => 'https://test.ru/',
];
/\*\*
\* Нам необходимо инициировать запрос к серверу.
\* Воспользуемся библиотекой cURL (поставляется в составе PHP).
\* Вы также можете использовать и кроссплатформенную программу cURL, если вы не программируете на PHP.
\*/
$curl = curl\_init(); //Сохраняем дескриптор сеанса cURL
/\*\* Устанавливаем необходимые опции для сеанса cURL \*/
curl\_setopt($curl,CURLOPT\_RETURNTRANSFER, true);
curl\_setopt($curl,CURLOPT\_USERAGENT,'amoCRM-oAuth-client/1.0');
curl\_setopt($curl,CURLOPT\_URL, $link);
curl\_setopt($curl,CURLOPT\_HTTPHEADER,['Content-Type:application/json']);
curl\_setopt($curl,CURLOPT\_HEADER, false);
curl\_setopt($curl,CURLOPT\_CUSTOMREQUEST, 'POST');
curl\_setopt($curl,CURLOPT\_POSTFIELDS, json\_encode($data));
curl\_setopt($curl,CURLOPT\_SSL\_VERIFYPEER, 1);
curl\_setopt($curl,CURLOPT\_SSL\_VERIFYHOST, 2);
$out = curl\_exec($curl); //Инициируем запрос к API и сохраняем ответ в переменную
$code = curl\_getinfo($curl, CURLINFO\_HTTP\_CODE);
curl\_close($curl);
/\*\* Теперь мы можем обработать ответ, полученный от сервера. Это пример. Вы можете обработать данные своим способом. \*/
$code = (int)$code;
$errors = [
400 => 'Bad request',
401 => 'Unauthorized',
403 => 'Forbidden',
404 => 'Not found',
500 => 'Internal server error',
502 => 'Bad gateway',
503 => 'Service unavailable',
];
try
{
/\*\* Если код ответа не успешный - возвращаем сообщение об ошибке \*/
if ($code  204) {
throw new Exception(isset($errors[$code]) ? $errors[$code] : 'Undefined error', $code);
}
}
catch(\Exception $e)
{
die('Ошибка: ' . $e->getMessage() . PHP\_EOL . 'Код ошибки: ' . $e->getCode());
}
/\*\*
\* Данные получаем в формате JSON, поэтому, для получения читаемых данных,
\* нам придётся перевести ответ в формат, понятный PHP
\*/
$response = json\_decode($out, true);
$access\_token = $response['access\_token']; //Access токен
$refresh\_token = $response['refresh\_token']; //Refresh токен
$token\_type = $response['token\_type']; //Тип токена
$expires\_in = $response['expires\_in']; //Через сколько действие токена истекает
```

### Долгосрочные токены

В феврале 2024 мы добавили возможность создавать долгосрочные токены для внешних и приватных интеграций.

Для создания необходимо перейти на вкладку “Ключи”, нажать кнопку “Сгенерировать токен”, выбрать дату окончания действия токена и скопировать токен. **После того, как токен создан, вы увидете его только один раз, поэтому его необходимо скопировать.**

![](https://www.amocrm.ru/uploads/2023/07/long-lived-desc.png) ![](https://www.amocrm.ru/uploads/2023/07/long-lived-modal.png)

Важно отметить, что подобные токены подойдут для небольших интеграций, которые разрабатываются под конкретный аккаунт. Срок действия токена пользователь выбирает сам и он действует от 1 дня до 5 лет. Кроме этого, во вкладке “Выданные доступы” долгосрочные токены имеют не только дату выдачи, но и дату окончания действия, но вы всегда можете отозвать сами нажав на кнопку “Отозвать доступ”.

Долгосрочные токены не имеют refresh\_token и поэтому не требуют обмена и не требуют написания логики, которая будет следить за актуальностью токенов.

### Запросы к API с передачей access token

C помощью полученного Access токена вы можете легко делать запросы к API приложения.

Вам не нужно отправлять куки-файлы с каждым запросом, также вам нужно добавить заголовок Authorization: Bearer {access токен} во все ваши запросы к API amoCRM.

#### Пример запроса к методу account

```php
 'Bad request',
401 => 'Unauthorized',
403 => 'Forbidden',
404 => 'Not found',
500 => 'Internal server error',
502 => 'Bad gateway',
503 => 'Service unavailable',
];
try
{
/\*\* Если код ответа не успешный - возвращаем сообщение об ошибке \*/
if ($code  204) {
throw new Exception(isset($errors[$code]) ? $errors[$code] : 'Undefined error', $code);
}
} catch(\Exception $e)
{
die('Ошибка: ' . $e->getMessage() . PHP\_EOL . 'Код ошибки: ' . $e->getCode());
}
```

Подобным образом можно делать запросы ко всем методам API, на которые у токена хватает прав. Токен имеет права пользователя, который предоставил доступ.

### Хук об отключении интеграции

Начиная с ноября 2021 года, вы можете указать адрес, на который будет отправлен запрос, когда интеграция будет отключена. После получения хука вы сможете остановить интеграцию, ограничить запросы к аккаунту, в котором произошло отключение.

Мы рекомендуем указывать данную ссылку, так как это поможет вам не делать лишних запросов к API, отслеживать когда интеграция была отключена.

#### Проверка подлинности хука

Что бы удостоверится, что хук действительно пришел от amoCRM, а не от злоумышлеников, рекомендуется проверять подпись хука, передаваемую в GET-параметре signature, а так же id oauth-клиента интеграции, передаваемый в GET-параметре client\_uuid. В качестве подписи хука передается [HMAC](https://ru.wikipedia.org/wiki/HMAC), сообщением является конкатенация id oauth-клиента интеграции с id аккаунта, для которого отзывается токен, ключем – секретный ключ oauth-клиента интеграции, алгоритм шифровния – sha256.

##### Пример кода для проверки подлинности

```php
<?php
// id oauth-клиента интеграции
$clientId = 'xxx';
// секретный ключ oauth-клиента интеграции
$clientSecret = 'xxx';
if (empty($\_GET['client\_uuid']) || empty($\_GET['signature']) || empty($\_GET['account\_id'])) {
throw new \HttpInvalidParamException('Wrong hook format');
}
$hookClientId = $\_GET['client\_uuid'];
$hookSignature = $\_GET['signature'];
$hookAccountId = (int) $\_GET['account\_id'];
if ($clientId !== $hookClientId) {
throw new \Exception('Invalid hook signature');
}
if (!hash\_equals(
hash\_hmac('sha256', sprintf('%s|%s', $clientId, $hookAccountId), $clientSecret),
$hookSignature
)) {
throw new \Exception('Invalid hook signature');
}
// проверка подлинности пройденна, можно вызывать вашу логику обработки хука
```

### Обработка ошибок

В ходе отработки всей вышеуказанной логики может возникать ряд исключений, которые необходимо обрабатывать, рассмотрим каждое из них:

- Если пользователь не дал разрешение на доступ к аккаунту, в случае использования кнопки amoCRM, будет вызвана функция, которая передана в одном из параметров. Подробней можно прочесть в разделе [Кнопка amoCRM](https://www.amocrm.ru/developers/content/oauth/button). Если же страница была открыта не кнопкой, то в случае отказа будет произведен редирект на Redirect URI c GET-параметром error=access\_denied.
- Если администратор аккаунта деактивировал установку интеграции, то выданные ей access\_token будут отозваны. При обращении к API вы получите HTTP код 401. Для продолжения работы интеграции интегратору необходимо снова получить авторизацию для его интеграции у пользователя.
- Если вы не записали актуальный refresh token, он был утерян, либо прошло более 3 месяцев, то для возобновления работы интеграции вам опять необходимо пройти процесс авторизации приложения.
- Если вами были утеряны основные ключи интеграции или вы случайно их опубликовали, то вы можете обновить секретный ключ в модальном окне интеграции в аккаунте, где она была создана. После обновления Secret Key интеграции вам необходимо обновить секретный ключ в конфигурациях ваших интеграциях.

---

#### Смотрите также

[Библиотека](https://www.amocrm.ru/developers/content/oauth/lib)  
[Кнопка на сайт](https://www.amocrm.ru/developers/content/oauth/button)