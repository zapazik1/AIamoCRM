# Логика Работы Виджета amoCRM

Этот документ описывает основной принцип работы кастомного виджета в среде amoCRM, фокусируясь на взаимодействии его ключевых частей без использования React.

## Ключевые Компоненты

1.  **amoCRM UI (Платформа)**: Основной веб-интерфейс amoCRM, в котором работает пользователь и в который встраивается виджет.
2.  **Frontend Виджета (JavaScript/jQuery)**: Код, выполняющийся в браузере пользователя. Состоит из:
    *   `manifest.json`: Конфигурационный файл, описывающий виджет для amoCRM.
    *   `script.js`: Точка входа, запускаемая amoCRM, содержит коллбэки жизненного цикла и основную логику виджета.
    *   `css/style.css`: Файл стилей для оформления элементов виджета.
    *   `i18n/*.json`: Файлы локализации для разных языков.
3.  **Backend Виджета (AI Сервер)**: Серверное приложение, которое обрабатывает логику, не выполняемую на клиенте (например, запросы к AI моделям, сложную бизнес-логику).
4.  **Браузер Пользователя**: Среда выполнения Frontend-кода виджета.

## Процесс Работы

1.  **Загрузка**: Пользователь заходит на страницу amoCRM. amoCRM читает `manifest.json` установленных виджетов. Если текущий раздел (`location`) совпадает с указанным в манифесте или установлен флаг `init_once: true`, amoCRM загружает указанный `script.js`.
    *   Протокол: Внутренние механизмы amoCRM.
2.  **Инициализация**: amoCRM исполняет `script.js` в контексте браузера пользователя. Вызывается коллбэк `init` из объекта `callbacks`, который вернул `script.js`.
    *   Протокол: JavaScript.
    *   В коллбэке `init` обычно инициализируются переменные, загружаются стили и создаются основные DOM-элементы виджета.
3.  **Рендеринг UI**: amoCRM вызывает коллбэк `render`. Внутри `render` наш код:
    *   Может использовать метод `render_template()` для добавления HTML-шаблона в DOM.
    *   Создает и добавляет нужные DOM-элементы через jQuery (например, `$('body').append(button)`).
    *   Протокол: JavaScript, DOM API, jQuery.
4.  **Привязка событий**: amoCRM вызывает коллбэк `bind_actions`. В этом коллбэке:
    *   Привязываются обработчики событий к созданным элементам (например, `$('.chat-button').on('click', function() {...})`).
    *   Настраивается взаимодействие с amoCRM через хуки и системные события.
    *   Протокол: JavaScript, DOM Events, jQuery.
5.  **Взаимодействие с Пользователем**: Пользователь кликает на элементы UI виджета (например, кнопку чата).
    *   Срабатывают зарегистрированные ранее обработчики событий.
    *   Обновляется DOM-структура страницы в соответствии с логикой виджета (например, отображается или скрывается окно чата).
    *   Протокол: События Браузера (DOM Events).
6.  **Отправка Запроса на Бэкенд**: Пользователь вводит сообщение в чат и нажимает "Отправить".
    *   Срабатывает обработчик события клика по кнопке отправки.
    *   Этот обработчик собирает данные и отправляет запрос на Backend Виджета, чаще всего используя метод `self.crm_post()` для обхода ограничений кросс-доменных запросов.
    *   Протокол: **HTTP/HTTPS** (обычно `POST` запрос с `JSON` в теле).
7.  **Обработка на Бэкенде**: Backend Виджета получает HTTP-запрос, обрабатывает его (например, обращается к внешней AI модели).
    *   Протокол: Зависит от бэкенда (например, HTTP/HTTPS к AI API).
8.  **Получение Ответа от Бэкенда**: Backend Виджета отправляет HTTP-ответ (успешный или с ошибкой) обратно на Frontend Виджета.
    *   Протокол: **HTTP/HTTPS** (ответ в формате `JSON`).
9.  **Отображение Ответа**: Frontend Виджета получает ответ в колбэк-функции запроса.
    *   Обработчик обновляет DOM-структуру, добавляя ответ от сервера в список сообщений.
    *   Может происходить дополнительная обработка ответа (форматирование, обработка специальных команд).
    *   Протокол: JavaScript, DOM API, jQuery.
10. **Обработка смены страницы**: При переходе пользователя между страницами amoCRM:
    *   В случае виджета с `init_once: true` срабатывает событие `page:changed`.
    *   Виджет должен обработать это событие, переприкрепив свои элементы к новой странице.
    *   Протокол: JavaScript, DOM Events.
11. **Взаимодействие с amoCRM API**: Frontend Виджета может делать запросы к публичному API amoCRM для получения данных или выполнения действий.
    *   Протокол: **HTTP/HTTPS** (REST API amoCRM, требует аутентификации).
12. **Завершение Работы**: Когда пользователь отключает виджет или он удаляется, amoCRM вызывает коллбэк `destroy`.
    *   Наш код в `destroy` должен очистить все ресурсы: удалить созданные DOM-элементы, отписаться от событий, обнулить внутренние переменные.
    *   Протокол: JavaScript, DOM API.

## Особенности Реализации

1. **Переиспользование DOM-элементов**: При работе с `init_once: true` виджет должен правильно управлять своими DOM-элементами при смене страниц, используя `.detach()` и `.append()` вместо повторного создания.

2. **Управление стилями**: Можно добавлять стили как через внешний CSS-файл, так и напрямую через jQuery `.css()`, что бывает более надежно в случае проблем с загрузкой внешних ресурсов.

3. **Работа с языковыми файлами**: Для локализации используется метод `self.i18n('key')`, который возвращает строку из соответствующего языкового файла.

4. **Хранение настроек**: Настройки, введенные пользователем, доступны через метод `self.get_settings()`.

5. **Обращение к системным данным**: Информация о текущем пользователе и аккаунте доступна через метод `self.system()`.

6. **Обработка выбранных элементов**: Для работы с выбранными элементами в списках (сделки, контакты) используются специальные коллбэки, например `contacts.selected`.

7. **Работа с меню**: Для добавления пунктов в левое меню amoCRM используется настройка `left_menu` в манифесте и коллбэк `initMenuPage`.



