# Техническое Задание: AI-помощник для amoCRM

## 1. Введение

### 1.1. Цель и назначение проекта
*   Назначение: Разработка интеллектуального AI-помощника (далее - Помощник), глубоко интегрированного в пользовательский интерфейс системы amoCRM.
*   Цель: Значительное повышение эффективности и удобства работы пользователей amoCRM за счет предоставления интеллектуальных функций: автоматизация рутинных операций, быстрый поиск и анализ информации, проактивная помощь на основе текущего контекста пользователя, выполнение действий в системе по запросу на естественном языке.

### 1.2. Краткое описание AI-помощника и его преимуществ
*   Описание: Помощник реализуется в виде чат-интерфейса, доступного непосредственно в окне amoCRM. Он способен понимать запросы пользователя, сформулированные на естественном русском языке, касающиеся данных и функциональности amoCRM (сделок, контактов, компаний, задач, отчетов и т.д.). Помощник может не только предоставлять информацию, но и выполнять действия от имени пользователя (с соответствующими проверками прав доступа) – создавать, редактировать, искать сущности, ставить задачи, анализировать данные.
*   Ключевая особенность: Использование технологии Model Context Protocol (MCP) позволяет Помощнику учитывать *контекст* работы пользователя (какой раздел открыт, какая карточка просматривается, какой текст выделен и т.д.), что делает его ответы и действия максимально релевантными и полезными.
*   Преимущества:
    *   Экономия времени пользователей на поиск информации и выполнение стандартных операций.
    *   Снижение вероятности ошибок при вводе данных.
    *   Улучшение общего пользовательского опыта работы с amoCRM.
    *   Возможность быстрого получения сводной информации и аналитики без необходимости формировать сложные фильтры вручную.
    *   Проактивные подсказки и помощь (в перспективе).

### 1.3. Обзор используемых технологий (Предварительный)
*   Model Context Protocol (MCP): Как основа для передачи контекста от фронтенда к бэкенду AI.
*   Frontend (Виджет amoCRM): JavaScript, HTML, CSS. Вероятно использование UI-фреймворка (например, React, Vue или Preact) для построения интерфейса чата.
*   Backend (Сервер AI): Python с использованием фреймворка FastAPI (или аналогов). Библиотеки для обработки естественного языка (NLP), взаимодействия с LLM и amoCRM API.
*   AI (LLM): Интеграция с одной из крупных языковых моделей через API (например, Google Gemini API, OpenAI API, Anthropic Claude API).
*   Интеграция с amoCRM: Через официальный amoCRM API v4.

### 1.4. Определения и сокращения
*   AI: Artificial Intelligence (Искусственный Интеллект).
*   CRM: Customer Relationship Management (Система управления взаимоотношениями с клиентами).
*   Помощник: Разрабатываемая система AI-помощника для amoCRM.
*   MCP: Model Context Protocol.
*   LLM: Large Language Model (Большая Языковая Модель).
*   API: Application Programming Interface (Программный интерфейс приложения).
*   MVP: Minimum Viable Product (Минимально Жизнеспособный Продукт).
*   ТЗ: Настоящее Техническое Задание.
*   Сущность: Стандартный объект в amoCRM (Сделка, Контакт, Компания, Задача и т.д.).

## 2. Требования к системе

### 2.1. Функциональные требования

#### 2.1.1. Интерфейс чата Помощника
*   Размещение: Чат Помощника должен быть доступен из любого раздела amoCRM.
    *   Точка входа в чат - плавающая круглая кнопка (виджет), доступная во всех разделах интерфейса amoCRM. По клику на кнопку открывается окно чата Помощника. (Необходимо будет проверить техническую реализуемость постоянного отображения плавающей кнопки через API виджетов amoCRM).
*   Активация: Пользователь должен иметь возможность легко открыть и закрыть окно чата.
    *   Активация происходит кликом по плавающей иконке Помощника.
*   Основные элементы интерфейса:
    *   Поле для ввода текстового запроса пользователя.
    *   Область отображения истории диалога (запросы пользователя, ответы Помощника, системные сообщения).
    *   Кнопка для отправки запроса.
    *   Индикатор статуса Помощника (ожидание ввода, обработка запроса, вывод ответа).
    *   (Опционально) Возможность копирования текста из сообщений Помощника.
    *   (Опционально) Возможность очистки истории диалога.
*   Внешний вид: Дизайн чата должен быть лаконичным и соответствовать общему стилю интерфейса amoCRM.

#### 2.1.2. Аутентификация и Авторизация
*   Идентификация пользователя: Система должна автоматически определять текущего пользователя amoCRM, который взаимодействует с Помощником. Отдельный вход в чат не требуется.
    *   Помощник действует от имени вошедшего в систему пользователя amoCRM, используя его права доступа, полученные через API виджетов/аутентификации amoCRM.
*   Учет прав доступа: Все операции по чтению и модификации данных в amoCRM, инициированные через Помощника, должны выполняться с учетом прав доступа текущего пользователя amoCRM. Если у пользователя нет прав на какое-то действие, Помощник должен корректно отказать в выполнении и сообщить об этом.

#### 2.1.3. Взаимодействие с amoCRM API (Базовый набор для MVP)
*   Чтение данных:
    *   Поиск Контактов: Возможность найти контакты по запросу пользователя по ФИО, номеру телефона, email.
    *   Поиск Сделок: Возможность найти сделки по запросу пользователя по названию, ID, имени связанного контакта/компании, воронке продаж, этапу воронки, дате создания.
    *   Отображение результатов: Найденные сущности (контакты, сделки) отображаются в виде простого текста в окне чата.
*   Запись данных (Функционал для MVP):
    *   Создание Задачи: Возможность поставить задачу по запросу пользователя. Помощник должен уметь извлекать из запроса или уточнять у пользователя следующие данные: текст задачи, ответственный пользователь, срок выполнения, связанная сущность (сделка или контакт).

#### 2.1.4. Обработка естественного языка (NLP)
*   Помощник должен понимать простые запросы на русском языке, касающиеся поиска и (если реализуем) создания сущностей (контактов, сделок, задач).
*   Помощник должен уметь извлекать ключевые параметры из запроса (например, имя контакта, название сделки, текст задачи, срок).
*   Если информации в запросе недостаточно для выполнения действия, Помощник должен задавать уточняющие вопросы.

#### 2.1.5. Реализация Model Context Protocol (MCP) (Базовая для MVP)
*   Помощник должен получать базовый контекст из фронтенд-виджета amoCRM.
    *   Минимальный набор контекстной информации для MVP: тип и ID сущности (сделки, контакта, компании), карточка которой открыта пользователем в данный момент.

### 2.2. Нефункциональные требования

#### 2.2.1. Производительность
*   Время ответа: Время от отправки запроса пользователя до получения ответа от Помощника должно быть приемлемым.
    *   Максимальное время ответа для MVP - до 15 секунд. Это время включает в себя обработку NLP, запрос к LLM и запрос к API amoCRM (если нужен).
*   Нагрузка на API amoCRM: Помощник должен использовать API amoCRM эффективно, чтобы не превышать лимиты запросов, установленные amoCRM. Возможно, потребуется кэширование некоторых данных.

#### 2.2.2. Надежность и Отказоустойчивость
*   Обработка ошибок: Помощник должен корректно обрабатывать возможные ошибки:
    *   Ошибки при взаимодействии с API amoCRM (недоступность, ошибки авторизации, превышение лимитов).
    *   Ошибки при взаимодействии с API LLM (недоступность, ошибки модели).
    *   Ошибки при обработке запроса пользователя (некорректный запрос, невозможность извлечь параметры).
    *   В случае ошибки Помощник должен выдавать пользователю понятное сообщение об ошибке, не прерывая работу чата полностью (если это возможно).
*   Стабильность виджета: Фронтенд-часть (виджет) должна работать стабильно и не вызывать ошибок в интерфейсе amoCRM.

#### 2.2.3. Безопасность
*   API Ключи: Ключи доступа к API LLM и API amoCRM (если используется отдельный сервисный ключ, а не ключ пользователя) должны храниться безопасно на бэкенде и не передаваться на фронтенд.
*   Данные пользователя: Система не должна хранить конфиденциальные данные пользователей amoCRM (кроме, возможно, временного кэширования для производительности или логов диалогов, если это будет необходимо и согласовано). Передача данных между компонентами должна быть защищена (HTTPS).

#### 2.2.4. Масштабируемость (Базовые требования для MVP)
*   Архитектура бэкенда должна позволять горизонтальное масштабирование (запуск нескольких экземпляров) при росте нагрузки, если потребуется в будущем.

#### 2.2.5. Удобство использования (Usability)
*   Интерфейс чата должен быть интуитивно понятным.
*   Формулировки ответов Помощника должны быть четкими, ясными и недвусмысленными.

## 3. Архитектура системы

### 3.1. Общая схема взаимодействия компонентов:

Пользователь (в amoCRM) <-> Фронтенд-виджет (в браузере) <-> Бэкенд AI (сервер) <-> API Языковой Модели (LLM)
                                                                    ^
                                                                    |
                                                                    v
                                                                API amoCRM

Объяснение схемы:
1. Пользователь вводит запрос в чат виджета в amoCRM.
2. Виджет собирает запрос и контекст (например, ID открытой сделки) и отправляет их на Бэкенд AI.
3. Бэкенд AI обрабатывает запрос:
    - Понимает намерение пользователя (NLP).
    - Если нужно, запрашивает данные из amoCRM через API amoCRM.
    - Формирует промпт для Языковой Модели (LLM), включая запрос пользователя и полученный контекст/данные.
    - Отправляет промпт на API LLM.
4. LLM генерирует ответ или команду для выполнения действия.
5. Бэкенд AI получает ответ от LLM:
    - Если это просто ответ - отправляет его в виджет.
    - Если это команда (например, "создать задачу") - выполняет ее через API amoCRM, а затем сообщает результат пользователю через виджет.
6. Виджет отображает ответ пользователю.

### 3.2. Описание компонентов (MVP):

*   Фронтенд-виджет:
    - Реализуется как виджет amoCRM на JavaScript, HTML, CSS.
    - Отвечает за: отображение интерфейса чата (плавающая кнопка, окно чата), сбор запроса пользователя, сбор базового контекста (тип/ID сущности), отправку данных на бэкенд, отображение ответов.
*   Бэкенд AI:
    - Реализуется на Python (FastAPI).
    - Отвечает за: прием запросов от виджета, обработку естественного языка (извлечение намерений и параметров), взаимодействие с API amoCRM (чтение/запись данных от имени пользователя), взаимодействие с API LLM (отправка промптов, получение ответов), оркестрацию всего процесса, хранение API-ключей.
*   API Языковой Модели (LLM):
    - Внешний сервис (например, Gemini API, OpenAI API).
    - Отвечает за: генерацию текстовых ответов на основе промптов, помощь в понимании запросов и извлечении данных.
*   API amoCRM:
    - Внешний сервис amoCRM.
    - Отвечает за: предоставление доступа к данным (контакты, сделки, задачи) и выполнение действий (создание задачи) программным способом.

## 4. Технологический стек (Предварительный для MVP)

*   Frontend (Виджет amoCRM):
    - Языки: JavaScript, HTML, CSS.
    - Фреймворк: React (или Vue/Preact - по выбору разработчика).
    - Библиотеки: Библиотека для HTTP-запросов (например, axios), возможно UI-библиотека компонентов.
*   Backend (Сервер AI):
    - Язык: Python (версия 3.11+).
    - Фреймворк: FastAPI.
    - Библиотеки:
        - HTTP-клиент (например, httpx или requests) для взаимодействия с API LLM и amoCRM.
        - Библиотеки для работы с API LLM (зависит от выбранного провайдера - google-generativeai, openai и т.д.).
        - (Опционально) Библиотека для работы с API amoCRM (если найдется подходящая и актуальная).
        - (Опционально) Библиотеки для базовой NLP (например, для извлечения сущностей, если LLM не справится или для предобработки).
*   AI Модель (LLM):
    - Один из внешних API: Google Gemini API / OpenAI API / Anthropic Claude API (выбор на этапе реализации или прототипирования).
*   Взаимодействие с amoCRM:
    - amoCRM API v4 (через HTTPS).
*   База данных:
    - Для MVP не используется. Логирование диалогов может осуществляться в файлы или стандартный вывод для простоты.

## 5. Инструменты разработки и развертывания (Предварительный для MVP)

*   Система контроля версий: Git.
*   Репозиторий: GitHub / GitLab / Bitbucket.
*   Среда разработки (IDE): VS Code / PyCharm.
*   Управление зависимостями: pip + requirements.txt (или Poetry) для Python, npm (или yarn) для JavaScript.
*   Контейнеризация: Docker (для упрощения локальной разработки и будущего развертывания).
*   Развертывание (варианты):
    - Простой VPS (виртуальный сервер).
    - PaaS-платформа (Heroku, Render, etc.).
    - Serverless-функции (AWS Lambda, Google Cloud Functions, etc.).
    - (Для MVP можно начать с простого VPS или PaaS).
*   Тестирование:
    - Python: Pytest.
    - JavaScript: Jest (или аналоги).
*   Мониторинг/Логирование (для MVP):
    - Базовое логирование в файлы или stdout/stderr. Интеграция со сложными системами мониторинга (Sentry, Grafana) - за рамками MVP.

## 6. Этапы разработки и MVP

### 6.1. Определение MVP (Minimum Viable Product)

MVP включает в себя базовую функциональность, позволяющую пользователям amoCRM взаимодействовать с AI-Помощником для получения информации и выполнения простых действий.

Функционал MVP:
*   Интерфейс: Плавающая кнопка-виджет, окно чата с полем ввода и областью диалога (см. п. 2.1.1).
*   Аутентификация: Работа от имени текущего пользователя amoCRM (см. п. 2.1.2).
*   Поиск данных: Поиск контактов (по ФИО, телефону, email) и сделок (по названию, ID, контакту/компании, воронке, этапу, дате создания) через API amoCRM (см. п. 2.1.3). Результаты отображаются текстом в чате.
*   Создание данных: Создание задач (с указанием текста, ответственного, срока, связанной сущности) через API amoCRM (см. п. 2.1.3).
*   Обработка языка: Понимание простых запросов на поиск/создание задачи, извлечение параметров, уточняющие вопросы через LLM (см. п. 2.1.4).
*   Контекст (MCP): Передача типа и ID открытой сущности (контакт, сделка, компания) от виджета на бэкенд (см. п. 2.1.5).
*   Производительность: Время ответа до 15 секунд (см. п. 2.2.1).
*   Надежность: Базовая обработка ошибок API и LLM (см. п. 2.2.2).
*   Безопасность: Хранение ключей на бэкенде (см. п. 2.2.3).

Функционал, НЕ входящий в MVP (примеры):
*   Сложные аналитические запросы и отчеты.
*   Поиск по всем полям сущностей.
*   Создание/редактирование контактов, сделок, компаний.
*   Работа с переписками, файлами, лентой событий.
*   Продвинутый сбор контекста MCP (выделенный текст, URL и т.д.).
*   Проактивные подсказки.
*   Кастомизация интерфейса или поведения.
*   Хранение истории диалогов в БД.
*   Продвинутый мониторинг и логирование.

### 6.2. Этапы разработки MVP (Примерный план)

1.  **Настройка окружения и инфраструктуры:**
    *   Создание репозитория Git.
    *   Настройка базового проекта Backend (Python 3.11/FastAPI).
    *   Настройка базового проекта Frontend-виджета (JS/React).
    *   Настройка Docker для локальной разработки.
    *   Выбор и настройка базового варианта развертывания (например, PaaS).
2.  **Разработка базового виджета:**
    *   Создание структуры виджета amoCRM.
    *   Реализация интерфейса чата (кнопка, окно, поле ввода, область диалога).
    *   Установка соединения между виджетом и бэкендом (например, через WebSockets или HTTP-polling).
3.  **Интеграция с API amoCRM (Аутентификация и Чтение):**
    *   Реализация получения токена/аутентификации пользователя на бэкенде.
    *   Реализация функций на бэкенде для поиска контактов по заданным полям через API amoCRM.
    *   Реализация функций на бэкенде для поиска сделок по заданным полям через API amoCRM.
4.  **Интеграция с LLM:**
    *   Выбор провайдера LLM и получение API ключа.
    *   Реализация базовой функции на бэкенде для отправки запроса пользователя (и промпта) в LLM и получения ответа.
5.  **Сборка основного сценария (Поиск):**
    *   На бэкенде: обработка запроса от виджета -> определение намерения "поиск" (с помощью LLM или просто по ключевым словам) -> вызов функции поиска amoCRM -> формирование ответа -> отправка ответа в виджет.
    *   На фронтенде: отправка запроса -> отображение ответа.
6.  **Интеграция с API amoCRM (Запись - Создание задачи):**
    *   Реализация функции на бэкенде для создания задачи через API amoCRM.
7.  **Сборка сценария (Создание задачи):**
    *   На бэкенде: обработка запроса -> определение намерения "создать задачу" -> извлечение параметров (текст, срок, ответственный, сущность - с помощью LLM или регулярных выражений/ключевых слов) -> уточняющие вопросы (если нужно) через LLM -> вызов функции создания задачи -> формирование ответа о результате -> отправка в виджет.
8.  **Реализация базового MCP:**
    *   На фронтенде: получение ID/типа открытой сущности -> передача этой информации на бэкенд вместе с запросом.
    *   На бэкенде: прием контекста -> включение его в промпт для LLM.
9.  **Тестирование и отладка:**
    *   Написание базовых тестов (unit/integration).
    *   Ручное тестирование основных сценариев.
    *   Исправление ошибок.
10. **Развертывание MVP:**
    *   Развертывание бэкенда и фронтенда на выбранной платформе.
    *   Финальное тестирование в "боевом" окружении amoCRM.
